#+title Deftpunk Emacs
#+author: Erick Bodine <erick.bodine@gmail.com>
#+property: header-args :tangle "/Users/bodine/MyStuff/dftpunk-emacs/init.el"
#+startup: content
#+auto_tangle: t

* About

My version of Emacs for MacOS - an attempt to be more minimalistic &
use builtin functionality.  All of which is, of course, relative.

** Install

Some utilities to install first:

- git
- ripgrep

* Early-Init
:properties:
:header-args: :tangle "/Users/bodine/MyStuff/dftpunk-emacs/early-init.el"
:end:
#+name: early-init-header-block
#+begin_src emacs-lisp :exports none
;;; early-init.el --- deftpunk early-init file. -*- lexical-binding: t; buffer-read-only: t -*-
;;;
;;; Commentary:
;;; This file was automatically generated by `org-babel-tangle'.
;;; Do not change this file.  Main config is located in emacs.d/dftpnk-emacs.org
;;;
;;; Code:
#+end_src

** Adjust garbage collection & other startup/performance optimizations

You'll see this modification in many config files around the internet. The idea is that emacs sets it's memory
threshold 40 years in the past. This causes the garbage collector to run frequently and can cause delays or
muck up the speed of your setup. We pretty much disable garbage collection during the initial phase to improve
our startup time. After we have given enough time for everything to load we then set the gc-theshold to a
reasonable number. Sometimes people set the threshold back to its default value, but I keep it a little higher
to handle things like fuzzy completion and language-server requirements. (See also GCMH Mode)

#+begin_src emacs-lisp :name garbage-collection
  ;; Time how long Emacs starts up.
  ;; Use a hook so the message doesn't get clobbered by other messages.
  (add-hook 'emacs-startup-hook
            (lambda ()
              (message "Emacs ready in %s with %d garbage collections."
                       (format "%.2f seconds"
                               (float-time
                                (time-subtract after-init-time before-init-time)))
                       gcs-done)))

  (defvar default-file-name-handler-alist file-name-handler-alist)
  (defvar extended-gc-cons-threshold most-positive-fixnum)
  (defvar default-gc-cons-threshold (* 100 1024 1024))

  ;; Native Compilation Vars
  (when (featurep 'native-compile)
    (setq native-comp-speed 2
          native-comp-async-report-warnings-errors nil
          native-comp-deferred-compilation t)
    ;; Set the right directory to store the native compilation cache
    ;; NOTE the method for setting the eln-cache directory depends on the emacs version
    (when (fboundp 'startup-redirect-eln-cache)
      (if (version< emacs-version "29")
          (add-to-list 'native-comp-eln-load-path (convert-standard-filename (expand-file-name "var/eln-cache/" user-emacs-directory)))
        (startup-redirect-eln-cache (convert-standard-filename (expand-file-name "var/eln-cache/" user-emacs-directory))))))

  ;; Prevents libgccjit error
  ;; Solution found at: https://github.com/d12frosted/homebrew-emacs-plus/issues/323
  (setenv "LIBRARY_PATH" "/usr/local/opt/gcc/lib/gcc/13:/usr/local/opt/libgccjit/lib/gcc/13:/usr/local/opt/gcc/lib/gcc/13/gcc/x86_64-apple-darwin21/13")

  (setq-default auto-window-vscroll nil
                bidi-display-reordering 'left-to-right
                bidi-paragraph-direction 'left-to-right
                frame-inhibit-implied-resize t
                inhibit-default-init t
                site-run-file nil
                load-prefer-newer t
                read-process-output-max (* 1024 1024 3))

  (setq file-name-handler-alist nil
        package-enable-at-startup nil
        gc-cons-threshold extended-gc-cons-threshold)

  (defun arco/return-gc-to-default ()
    (setq-default gc-cons-threshold default-gc-cons-threshold
                  load-prefer-newer nil))

  (defun arco/reset-file-handler-alist-h ()
    (dolist (handler file-name-handler-alist)
      (add-to-list 'default-file-name-handler-alist handler))
    (setq file-name-handler-alist default-file-name-handler-alist))

  (defun deftpunk/startup-time ()
    "Display garbage collections and startup time."
    (let ((garbage-collection-messages t)) (garbage-collect))
    (let ((msg (format "started (%d) in %s" (emacs-pid) (emacs-init-time))))
      (message (concat "emacs: " msg))))

  (add-hook 'after-init-hook #'arco/reset-file-handler-alist-h)
  (add-hook 'after-init-hook #'arco/return-gc-to-default)
  (add-hook 'after-init-hook #'deftpunk/startup-time)
  (advice-add #'package--ensure-init-file :override #'ignore)

  ;; Prevent unwanted runtime builds in gccemacs (native-comp); packages are
  ;; compiled ahead-of-time when they are installed and site files are compiled
  ;; when gccemacs is installed.
  (setq comp-deferred-compilation nil)

  ;; remove searching for .gz files, as all my packages are uncompressed
  ;; this halves how many files emacs tries to open (if you have a lot of
  ;; packages, emacs executes a lot of failing file opens)
  (setq jka-compr-load-suffixes nil)
  (jka-compr-update)
#+end_src

** Pre-Gui Configuration & Optimization

Ever since Emacs 27.0 we can utilize the early-init file to setup a few graphical settings without seeing a
major slow down. The biggest speed ups I've seen from this is setting =vertical-scroll-bars= , =ns-appearance=,
and =ns-transparent-titlebar=.  We also handle a few other graphical settings.

#+begin_src emacs-lisp :name gui-optimization
  ;; Some nice UI tweaks that improve performance when specified
  ;; in early-init.el
  (modify-all-frames-parameters '((width . 105)
                                  (height . 100)
                                  (left . 0)
                                  (right . 0)
                                  (internal-border-width . 1)
                                  (vertical-scroll-bars . nil)
                                  (tool-bar-lines . 0)
                                  (ns-appearance . dark)
                                  ))

  ;; Prevent the glimpse of un-styled Emacs by disabling these UI elements early.
  (push '(menu-bar-lines . 0) default-frame-alist)
  (push '(tool-bar-lines . 0) default-frame-alist)
  (push '(vertical-scroll-bars) default-frame-alist)

  ;; Resizing the Emacs frame can be a terribly expensive part of changing the
  ;; font. By inhibiting this, we easily halve startup times with fonts that are
  ;; larger than the system default.
  (setq frame-inhibit-implied-resize t)

  ;; Get rid of any window chrome.
  (when window-system
    (menu-bar-mode -1)
    (tool-bar-mode -1)
    (scroll-bar-mode -1)
    (tooltip-mode -1))
  (setq inhibit-splash-screen t)
  (setq use-file-dialog nil)

  ;; Want square corners when no titlebars
  ;; 2023-08-11T22:19:27 > this looks funky w/out a tiling window manager.
  ;; (add-to-list 'default-frame-alist '(undecorated . t))

#+end_src

** UTF-8

Set everything to UTF-8

#+begin_src emacs-lisp :name utf-8
  (setq default-input-method nil
        utf-translate-cjk-mode nil)
  (set-language-environment 'utf-8)

  ;; Make UTF-8 the default coding system.
  (when (fboundp 'set-charset-priority)
    (set-charset-priority 'unicode))
  (prefer-coding-system 'utf-8)
  (setq locale-coding-system 'utf-8
        selection-coding-system 'utf-8)

  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-selection-coding-system 'utf-8)
  (prefer-coding-system 'utf-8)
#+end_src

** Bonus keys

This allows us of C-i, C-m & C-[ ... you know, like other editors can.
https://emacsnotes.wordpress.com/2022/09/11/three-bonus-keys-c-i-c-m-and-c-for-your-gui-emacs-all-with-zero-headache/

#+begin_src emacs-lisp :name bonus-keys
  (add-hook
   'after-make-frame-functions
   (defun setup-blah-keys (frame)
     (with-selected-frame frame
       (when (display-graphic-p) ; don't remove this condition, if you want
                                          ; terminal Emacs to be usable
         ;; - When you type `Ctrl-i', Emacs see it as `BLAH-i', and NOT as 'Tab'
         ;; - When you type `Ctrl-m', Emacs see it as `BLAH-m', and NOT as 'Return'
         ;; - When you type `Ctrl-[', Emacs see it as `BLAH-lsb', and not as 'Esc'.
         ;;
         ;; That is,
         ;;
         ;; - `Ctrl-i' and 'Tab' keys are different
         ;; - `Ctrl-m' and 'Return' keys are different
         ;; - `Ctrl-[' and 'Esc' keys are different
         ;;
         ;; The three BLAH keys are the bonus keys.
         (define-key input-decode-map (kbd "C-i") [BLAH-i])
         (define-key input-decode-map (kbd "C-[") [BLAH-lsb]) ; left square bracket
         (define-key input-decode-map (kbd "C-m") [BLAH-m])
         ;; You can replace `BLAH-' above with `C-' or
         ;; `CONTROL-', it doesnt' matter.
         ;;
         ;; BLAH is merely a symbol / name; feel free to change
         ;; it to whatever you like .
         ))))
#+end_src

** Early key unset/set

#+begin_src emacs-lisp :name unset-set-keys
  ;; Unbind some Super keys.
  (global-unset-key (kbd "s-a"))
  (global-unset-key (kbd "s-f"))
  (global-unset-key (kbd "s-g"))
  (global-unset-key (kbd "s-i"))
  (global-unset-key (kbd "s-o"))
  (global-unset-key (kbd "s-p"))
  (global-unset-key (kbd "s-s"))
  (global-unset-key (kbd "s-t"))
#+end_src

#+name: early-init-footer-block
#+begin_src emacs-lisp :exports none
(provide 'early-init)
;;; early-init.el ends here
#+end_src

* Init
#+name: init-header-block
#+begin_src emacs-lisp :exports none
;;; init.el --- deftpunk Emacs config file -*- lexical-binding: t; buffer-read-only: t -*-
;;;
;;; Commentary:
;;; Emacs `init.el' config for deftpunk
;;; This file was automatically generated by `org-babel-tangle'.
;;; Do not change this file.  Main config is located in emacs.d/deftpunk-emacs.org
;;;
;;; Code:
#+end_src

** Set some deftpunk variables

=etc/= - For files & directories that we save across systems, e.g. dictionaries, abbreviations
=var/= - For files & directories that are local, e.g. caches, backups

#+begin_src emacs-lisp :name globals

  (defconst deftpunk--emacs-dir (file-truename "~/.emacs.d")
    "The path to the emacs.d directory")

  (defconst deftpunk--org-configuration-file (concat deftpunk--emacs-dir "/deftpunk-emacs.org")
    "The Org mode literate configuration file.")

  (defconst deftpunk--etc-dir (concat deftpunk--emacs-dir "/etc/")
    "Location for files to save across systems.")

  (defconst deftpunk--var-dir (concat deftpunk--emacs-dir "/var/")
    "Location for cache & files that we don't save across systems.")

  ;; I use Mac & occasionally Linux, no Windoze.
  (defconst IS-MAC (eq system-type 'darwin))
  (defconst IS-LINUX (eq system-type 'gnu/linux))
#+end_src

** Package Management

Starting to use elpaca with =use-package= instead of straight for package management.

*** [[https://github.com/progfolio/elpaca][elpaca]]

#+begin_src emacs-lisp :name elpaca
  (defvar elpaca-installer-version 0.6)
  (defvar elpaca-directory (expand-file-name "elpaca/" deftpunk--var-dir))
  (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
  (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
  (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                                :ref nil
                                :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                                :build (:not elpaca--activate-package)))
  (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
         (build (expand-file-name "elpaca/" elpaca-builds-directory))
         (order (cdr elpaca-order))
         (default-directory repo))
    (add-to-list 'load-path (if (file-exists-p build) build repo))
    (unless (file-exists-p repo)
      (make-directory repo t)
      (when (< emacs-major-version 28) (require 'subr-x))
      (condition-case-unless-debug err
          (if-let ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                   ((zerop (call-process "git" nil buffer t "clone"
                                         (plist-get order :repo) repo)))
                   ((zerop (call-process "git" nil buffer t "checkout"
                                         (or (plist-get order :ref) "--"))))
                   (emacs (concat invocation-directory invocation-name))
                   ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                         "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                   ((require 'elpaca))
                   ((elpaca-generate-autoloads "elpaca" repo)))
              (progn (message "%s" (buffer-string)) (kill-buffer buffer))
            (error "%s" (with-current-buffer buffer (buffer-string))))
        ((error) (warn "%s" err) (delete-directory repo 'recursive))))
    (unless (require 'elpaca-autoloads nil t)
      (require 'elpaca)
      (elpaca-generate-autoloads "elpaca" repo)
      (load "./elpaca-autoloads")))
  (add-hook 'after-init-hook #'elpaca-process-queues)
  (elpaca `(,@elpaca-order))

  ;; Install a package via the elpaca macro
  ;; See the "recipes" section of the manual for more details.

  ;; (elpaca example-package)

  ;; Install use-package support
  (elpaca elpaca-use-package
    ;; Enable :elpaca use-package keyword.
    (elpaca-use-package-mode)
    ;; Assume :elpaca t unless otherwise specified.
    (setq elpaca-use-package-by-default t))

  ;; Block until current queue processed.
  (elpaca-wait)

  ;;When installing a package which modifies a form used at the top-level
  ;;(e.g. a package which adds a use-package key word),
  ;;use `elpaca-wait' to block until that package has been installed/configured.
  ;;For example:
  ;;(use-package general :demand t)
  ;;(elpaca-wait)

  ;; Expands to: (elpaca evil (use-package evil :demand t))
  ;; (use-package evil :demand t)

  ;;Turns off elpaca-use-package-mode current declaration
  ;;Note this will cause the declaration to be interpreted immediately (not deferred).
  ;;Useful for configuring built-in emacs features.
  ;; (use-package emacs :elpaca nil :config (setq ring-bell-function #'ignore))

  ;; Don't install anything. Defer execution of BODY
  ;; (elpaca nil (message "deferred"))
#+end_src

*** [[https://github.com/noctuid/general.el][General]]

Better manage some keybindings.

#+begin_src emacs-lisp :name general.el
  (use-package general)

  (elpaca-wait)

  ;; local leader
  ;; This allows for finer granularity than hydra-major-mode by binding to individual key maps.
  (general-create-definer deftpunk-local-leader-def
    :keymaps 'override
    :prefix "C-;")
#+end_src

*** [[https://github.com/radian-software/blackout][Blackout]]

Clean up the modeline.  Adds =:blackout= to =use-package= declarations.

#+begin_src emacs-lisp :name blackout
  (use-package blackout)
  (elpaca-wait)
#+end_src
*** [[https://github.com/ajgrf/on.el][on.el]]

Some utility hooks and functions from Doom Emacs.

Hooks:
=on-first-input= - eg. delay loading which-key-mode until the 1st keys is pressed.
=on-first-file=
=on-first-buffer=
=on-init-ui=
=on-switch-buffer=
=on-switch-frame=
=on-switch-window=

#+begin_src emacs-lisp :name on.el
  (use-package on
    :elpaca (:host github :repo "ajgrf/on.el")
    :config
    (elpaca-wait)
    (require 'on))
#+end_src

*** [[https://github.com/justbur/emacs-which-key][which-key]]

Display keybindings following your prefix command in a popup.

#+begin_src emacs-lisp :name which-key
  (use-package which-key
    :blackout
    :commands (which-key-mode)
    :hook (on-first-input . which-key-mode)
    :init
    (setq which-key-enable-exteded-define-key t
          which-key-idle-delay 0.5)
    :config
    (elpaca-wait)
    (which-key-mode +1))
#+end_src

*** [[https://github.com/abo-abo/hydra][hydra]]

Use hydra for repeating keys.

#+begin_src emacs-lisp :name hydra
  (use-package hydra)
  (elpaca-wait)
#+end_src

** Some useful functions

#+begin_src emacs-lisp :name some-macros-and-functions
  ;;; Some convenience macros from our favorite martian - Doom Emacs creator Henrik Lissner ;;;

  ;; 4/22/2020 - In after! below, I removed the check to see if the package was
  ;; in the list of doom-disabled-packages
  (defmacro after! (package &rest body)
    "Evaluate BODY after PACKAGE have loaded.

      PACKAGE is a symbol or list of them. These are package names, not modes,
      functions or variables. It can be:

      - An unquoted package symbol (the name of a package)
          (after! helm BODY...)
      - An unquoted list of package symbols (i.e. BODY is evaluated once both magit
        and git-gutter have loaded)
          (after! (magit git-gutter) BODY...)
      - An unquoted, nested list of compound package lists, using any combination of
        :or/:any and :and/:all
          (after! (:or package-a package-b ...)  BODY...)
          (after! (:and package-a package-b ...) BODY...)
          (after! (:and package-a (:or package-b package-c) ...) BODY...)
        Without :or/:any/:and/:all, :and/:all are implied.

      This is a wrapper around `eval-after-load' that:

      1. Suppresses warnings for disabled packages at compile-time
      2. No-ops for package that are disabled by the user (via `package!')
      3. Supports compound package statements (see below)
      4. Prevents eager expansion pulling in autoloaded macros all at once"
    (declare (indent defun) (debug t))
    (if (symbolp package)
        (list (if (or (not (bound-and-true-p byte-compile-current-file))
                      (require package nil 'noerror))
                  #'progn
                #'with-no-warnings)
              (let ((body (macroexp-progn body)))
                `(if (featurep ',package)
                     ,body
                   ;; We intentionally avoid `with-eval-after-load' to prevent
                   ;; eager macro expansion from pulling (or failing to pull) in
                   ;; autoloaded macros/packages.
                   (eval-after-load ',package ',body))))
      (let ((p (car package)))
        (cond ((not (keywordp p))
               `(after! (:and ,@package) ,@body))
              ((memq p '(:or :any))
               (macroexp-progn
                (cl-loop for next in (cdr package)
                         collect `(after! ,next ,@body))))
              ((memq p '(:and :all))
               (dolist (next (cdr package))
                 (setq body `((after! ,next ,@body))))
               (car body))))))

  (defmacro appendq! (sym &rest lists)
    "Append LISTS to SYM in place."
    `(setq ,sym (append ,sym ,@lists)))

  ;; TODO: Need the doom-enlist function definition for this to work.
  ;;  (defmacro defadvice! (symbol arglist &optional docstring &rest body)
  ;;    "Define an advice called SYMBOL and add it to PLACES.
  ;;
  ;;    ARGLIST is as in `defun'. WHERE is a keyword as passed to `advice-add', and
  ;;    PLACE is the function to which to add the advice, like in `advice-add'.
  ;;    DOCSTRING and BODY are as in `defun'.
  ;;
  ;;    \(fn SYMBOL ARGLIST &optional DOCSTRING &rest [WHERE PLACES...] BODY\)"
  ;;    (declare (doc-string 3) (indent defun))
  ;;    (unless (stringp docstring)
  ;;      (push docstring body)
  ;;      (setq docstring nil))
  ;;    (let (where-alist)
  ;;      (while (keywordp (car body))
  ;;        (push `(cons ,(pop body) (doom-enlist ,(pop body)))
  ;;              where-alist))
  ;;      `(progn
  ;;         (defun ,symbol ,arglist ,docstring ,@body)
  ;;         (dolist (targets (list ,@(nreverse where-alist)))
  ;;           (dolist (target (cdr targets))
  ;;             (advice-add target (car targets) #',symbol))))))
  ;;
  ;;  (defmacro delq! (elt list &optional fetcher)
  ;;    "`delq' ELT from LIST in-place.
  ;;      If FETCHER is a function, ELT is used as the key in LIST (an alist)."
  ;;    `(setq ,list
  ;;           (delq ,(if fetcher
  ;;                      `(funcall ,fetcher ,elt ,list)
  ;;                    elt)
  ;;                 ,list)))

  ;; There are certain buffers I don't want to delete on accident.
  ;; Code taken from https://github.com/rememberYou/.emacs.d/blob/master/config.org
  (defvar *protected-buffers* '("*scratch*" "*Messages*"))

  (defun arco/protected-buffers ()
    "Protects some buffers from being killed."
    (dolist (buffer *protected-buffers*)
      (if (get-buffer buffer)
          (with-current-buffer buffer
            (emacs-lock-mode 'kill))
        (get-buffer-create buffer)
        (with-current-buffer buffer
          (emacs-lock-mode 'kill)))))

  (general-add-hook 'emacs-startup-hook #'arco/protected-buffers)

    ;;;###autoload
  (defun deftpunk/timestamp ()
    (interactive)
    (insert (format-time-string "%Y-%m-%dT%H:%M:%S")))

    ;;;###autoload
  ;; https://stackoverflow.com/questions/251908/how-can-i-insert-current-date-and-time-into-a-file-using-emacs
  (defun today ()
    "Insert string for today's date nicely formatted in American style,
    e.g. Sunday, September 17, 2000."
    (interactive)                 ; permit invocation in minibuffer
    (insert (format-time-string "%A, %B %e, %Y")))

    ;;;###autoload
  (defun flex//kill-current-buffer ()
    "What it says."
    (interactive)
    (kill-buffer (current-buffer)))

  (defun vim-return ()
    "Still want Return to do the right thing in dired mode."
    (interactive)
    (if (eq major-mode 'dired-mode)
        (dired-find-file)
      (progn
        (next-line)
        (back-to-indentation-or-beginning))))

  ;; not broken, toggle letter case from
  ;; http://ergoemacs.org/emacs/modernization_upcase-word.html][xah]] originally.
  ;; http://stackoverflow.com/questions/18257573/how-to-toggle-letter-cases-in-a-region-in-emacs
  (defun toggle-letter-case ()
    "Toggle the letter case of current word or text selection.
     Toggles between: “all lower”, “Init Caps”, “ALL CAPS”."
    (interactive)
    (let (p1 p2 (deactivate-mark nil) (case-fold-search nil))
      (if (region-active-p)
          (setq p1 (region-beginning) p2 (region-end))
        (let ((bds (bounds-of-thing-at-point 'word) ) )
          (setq p1 (car bds) p2 (cdr bds)) ) )
      (when (not (eq last-command this-command))
        (save-excursion
          (goto-char p1)
          (cond
           ((looking-at "[[:lower:]][[:lower:]]") (put this-command 'state "all lower"))
           ((looking-at "[[:upper:]][[:upper:]]") (put this-command 'state "all caps") )
           ((looking-at "[[:upper:]][[:lower:]]") (put this-command 'state "init caps") )
           ((looking-at "[[:lower:]]") (put this-command 'state "all lower"))
           ((looking-at "[[:upper:]]") (put this-command 'state "all caps") )
           (t (put this-command 'state "all lower") ) ) ) )
      (cond
       ((string= "all lower" (get this-command 'state))
        (upcase-initials-region p1 p2) (put this-command 'state "init caps"))
       ((string= "init caps" (get this-command 'state))
        (upcase-region p1 p2) (put this-command 'state "all caps"))
       ((string= "all caps" (get this-command 'state))
        (downcase-region p1 p2) (put this-command 'state "all lower")) )
      ) )

  ;;
  (defun deftpunk/catch-error-p (func-symbol)
    "Call the passed function solely for the purpose of catching its error."
    (let (retval)
      (condition-case error
          (funcall func-symbol)
        ('error (setq retval error)))
      retval))

  ;; Full history of this function is foggy and lost to time.
  ;; https://stackoverflow.com/questions/234963/re-open-scratch-buffer-in-emacs
  (defun eme-goto-scratch ()
              "this sends you to the scratch buffer"
              (interactive)
              (let ((eme-scratch-buffer (get-buffer-create "*scratch*")))
      (switch-to-buffer eme-scratch-buffer)
      (lisp-interaction-mode)))

  ;; Some more excellence from karthinks.
  (defun repeated-prefix-help-command ()
    (interactive)
    (when-let* ((keys (this-command-keys-vector))
                (prefix (seq-take keys (1- (length keys))))
                (orig-keymap (key-binding prefix 'accept-default))
                (keymap (copy-keymap orig-keymap))
                (exit-func (set-transient-map keymap t #'which-key-abort)))
      (define-key keymap [remap keyboard-quit]
                  (lambda () (interactive) (funcall exit-func)))
      (which-key--create-buffer-and-show nil keymap)))
  (setq prefix-help-command #'repeated-prefix-help-command)
#+end_src

** Some initial packages and libraries
*** [[https://github.com/purcell/exec-path-from-shell][Exec-Path-From-Shell]]

Application launching on MacOS isn't handled by a specific system. This makes it really hard to get envrionment variables from your shell to show up in Emacs. This package makes that easier.

An insteresting article on shell startup: [[https://blog.flowblok.id.au/2013-02/shell-startup-scripts.html][shell startup scripts]]

#+begin_src emacs-lisp :name exec-path-from-shell
  (use-package exec-path-from-shell
    :commands (exec-path-from-shell-initialize)
    :config
    (dolist (var '( "CONDARC"
		    "CONDA_ENVS_PATH"
		    "FZF_DEFAULT_COMMAND"
		    "IPYTHONDIR"
		    "PYTHONPATH"
		    "JAVA_HOME"
		    "MYPY_CACHE_DIR"
		    "PATH"))
      (add-to-list 'exec-path-from-shell-variables var))
    (elpaca-wait))
  ;; Because MacOSX ??
;;  (exec-path-from-shell-initialize)
#+end_src

*** [[https://github.com/emacscollective/no-littering][no-littering]]

Helping keep my ~/.emacs.d clean.

#+begin_src emacs-lisp :name no-littering
  (use-package no-littering
    :init
    (setq no-littering-etc-directory deftpunk--etc-dir
          no-littering-var-directory deftpunk--var-dir)
    (setq auto-save-file-name-transforms
          `((".*" ,(expand-file-name "auto-save/" no-littering-var-directory) t))))
#+end_src

*** [[https://github.com/bbatsov/crux][crux]]

Some useful interactive commands from bbatsov

#+begin_src emacs-lisp :name crux
  (use-package crux
    :bind (("C-a" . crux-move-beginning-of-line)
           ("C-k" . crux-smart-kill-line)
           ("s-o" . crux-smart-open-line-above)
           ("s-RET" . crux-smart-open-line)))
#+end_src

** Appearance
*** Fonts

A million ways to set fonts in Emacs - we will deal with mixed & variable pitch later.
http://idiocy.org/emacs-fonts-and-fontsets.html
https://archive.casouri.cc/note/2021/fontset/index.html

2023-01-21 - This didn't work when it was in early-init.el

#+begin_src emacs-lisp :name Fonts
  (set-face-attribute 'default nil :font "Victor Mono" :height 110)
  (set-fontset-font t nil "Courier New" nil 'append) ; fallback font
#+end_src

*** [[https://github.com/domtronn/all-the-icons.el][all-the-icons]]

Make the icons in Emacs pretty. Don't forget to run =M-x all-the-icons-install-fonts= if this is a new install.

#+begin_src emacs-lisp :name all_the_icons
  (use-package all-the-icons)
#+end_src

*** [[https://github.com/hlissner/emacs-solaire-mode][solaire-mode]]

Help visually distinguish buffers. If you don't like the lighter/darker arrangement you can change it with =(add-to-list 'solaire-mode-themes-to-face-swap 'doom-vibrant)=

Supported themes:
- Doom themes
- nano-theme
- modus-themes
- parchment
- spacemacs-theme
- vscode-dark-plus-theme
- wilmersdorf-theme

#+begin_src emacs-lisp :name solaire-mode
  (use-package solaire-mode
    :config
    (solaire-global-mode +1))
#+end_src

** Completion Frameworks

*** vertico

*** [[https://github.com/minad/marginalia][Marginalia]]

Add marginalia to minibuffer completions.

#+begin_src emacs-lisp :name marginalia
  (use-package marginalia
    :general
    (:keymaps 'minibuffer-local-map
     "s-a" 'marginalia-cycle)
    :init
    (setq marginalia-max-relative-age 0
          marginalia-align 'right)
    (marginalia-mode))
#+end_src

** Emacs Defaults
#+begin_src emacs-lisp :name defaults
  (setq-default
   display-time-default-load-average nil            ; Don't display load average
   fill-column 100                                  ; Set column width
   help-window-select t                             ; Focus new help windows when opened
   indent-tabs-mode nil                             ; Prefer spaces over tabs, duh.
   tab-width 4                                      ; Set width for tabs
   kill-ring-max 128                                ; Maximum length of kill ring
   load-prefer-newer t                              ; Prefer the newest version of a file
   mark-ring-max 128                                ; Maximum length of mark ring
   select-enable-clipboard t                        ; Merge system's and Emacs' clipboard
   x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)
   user-full-name "ERick BOdine"                    ; Name
   vc-follow-symlinks t                             ; Always follow the symlinks
   frame-title-format '("Emacs: %f")                ; Frame title
   icon-title-format frame-title-format             ; OS icon title
   message-log-max 8192                             ; Don't lose any logging information.
   bidi-paragraph-separate-re "^"
   bidi-paragraph-start-re "^"
   ring-bell-function 'ignore                       ; Turn off the damn bell!
   history-delete-duplicates t                      ; Remove dups from helm-M-x & such.
   history-length 55                                ; Limit history length; see above.
   view-read-only t)                                ; Always open read-only buffers in view-mode

  ;; sane trackpad/mouse scroll settings
  (when IS-MAC
    (setq mac-redisplay-dont-reset-vscroll t
          mac-mouse-wheel-smooth-scroll nil))

  ;; Some IO related settings.
  ;; support reading large blobs of data
  (setq process-adaptive-read-buffering nil
        read-process-output-max (* 2048 2048))

  ;; Reduce rendering/line scan work for Emacs by not rendering cursors or regions
  ;; in non-focused windows.
  (setq-default cursor-in-non-selected-windows nil)
  (setq highlight-nonselected-windows nil)

  ;; More performant rapid scrolling over unfontified regions. May cause brief
  ;; spells of inaccurate syntax highlighting right after scrolling, which should
  ;; quickly self-correct.
  (setq fast-but-imprecise-scrolling t)
  (setq-default scroll-conservatively 101)

  ;; Resizing the Emacs frame can be a terribly expensive part of changing the
  ;; font. By inhibiting this, we halve startup times, particularly when we use
  ;; fonts that are larger than the system default (which would resize the frame).
  (setq frame-inhibit-implied-resize t)

  ;; Don't popup UI/graphical dialog boxes.
  (setq use-dialog-box nil)

  ;; Don't ping things that look like domain names.
  (setq ffap-machine-p-known 'reject)

  ;; Font compacting can be terribly expensive, especially for rendering icon
  ;; fonts on Windows. Whether it has a noteable affect on Linux and Mac hasn't
  ;; been determined, but we inhibit it there anyway.
  (setq inhibit-compacting-font-caches t)

  ;; Remove command line options that aren't relevant to our current OS; means
  ;; slightly less to process at startup.
  (unless IS-MAC   (setq command-line-ns-option-alist nil))
  (unless IS-LINUX (setq command-line-x-option-alist nil))

  ;; Make apropos more useful
  (setq apropos-do-all t)

  ;; Silence advised functions warnings
  (setq ad-redefinition-action 'accept)

  ;; Don't pass over `auto-mode-alist' a second time.
  (setq auto-mode-case-fold nil)

  ;; don't ask to kill buffers
  (setq kill-buffer-query-functions
        (remq 'process-kill-buffer-query-function
              kill-buffer-query-functions))

  ;; Get rid of "For information about GNU Emacs..." message at startup
  (unless noninteractive
    (advice-add #'display-startup-echo-area-message :override #'ignore)
    (setq inhibit-startup-message t
          inhibit-startup-echo-area-message user-login-name
          inhibit-default-init t
          ;; initial-major-mode 'fundamental-mode
          initial-scratch-message "Welcome to the Church of Emacs, Cardinal deftpunk presiding"
          mode-line-format nil))
  ;; we're in a daemon session, where it'll say "Starting Emacs daemon." instead
  (unless (daemonp)
    (advice-add #'display-startup-echo-area-message :override #'ignore))

  ;; This file stores usernames, passwords, and such.
  (setq auth-sources (list (expand-file-name "authinfo.gpg" deftpunk--etc-dir) "~/.authinfo.gpg"))

  ;; Some timezone stuff for logview.el and others.
  (setenv "TZ" "America/Denver")
  (setq datetime-timezone "America/Denver")

  ;; I actually find the custom system a nuisance; move the file out of the way.
  (setq custom-file (expand-file-name "custom.el" deftpunk--etc-dir))

  ;; Replace yes/no prompts with y/n
  (fset 'yes-or-no-p 'y-or-n-p)

  ;; see https://www.emacswiki.org/emacs/BrowseUrl#h5o-7
  (after! browse-url
    (setq browse-url-browser-function 'browse-url-chrome
          browse-url-chrome-program "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
          browse-url-new-window-flag  t))

  ;; Don't ask if you want to kill a buffer with a live process attached to it:
  (remove-hook 'kill-buffer-query-functions 'process-kill-buffer-query-function)

  (after! simple
          ;; The following may be of interest to people who (a) are happy with
          ;; "C-w" and friends for killing and yanking, (b) use
          ;; "transient-mark-mode", (c) also like the traditional Unix tty
          ;; behaviour that "C-w" deletes a word backwards. It tweaks "C-w" so
          ;; that, if the mark is inactive, it deletes a word backwards instead
          ;; of killing the region. Without that tweak, the C-w would create an
          ;; error text without an active region.
          ;; http://www.emacswiki.org/emacs/DefaultKillingAndYanking#toc2

          (defadvice kill-region (before unix-werase activate compile)
            "When called interactively with no active region, delete a single word backwards
             instead."
            (interactive
             (if mark-active (list (region-beginning) (region-end))
               (list (save-excursion (backward-word 1) (point)) (point))))))

  ;; Deleting past a tab normally changes tab into spaces. Don't do
  ;; that, kill the tab instead.
  (setq backward-delete-char-untabify-method nil)

  ;; Don't type C-u C-SPC C-u C-SPC to pop 2 marks, now you can do C-u C-SPC C-SPC
  (setq set-mark-command-repeat-pop t)

  ;; Revert buffers when the underlying file has changed.
  (global-auto-revert-mode 1)

  ;; no lockfiles
  (setq create-lockfiles nil)
#+end_src

** Emacs builtin modes
*** auto-save & backups

Saving and backing up files. While its nice to assume that everything is in source control this is a handy fallback.

#+begin_src emacs-lisp :name auto-save-backup
  (setq version-control t              ; Use version numbers for backup
        kept-new-versions 5            ; Number of newest version to keep around
        kept-old-versions 0            ; Number of oldest versions to keep around
        delete-old-versions t          ; Don't ask to delete older versions
        backup-by-copying t            ; Copy all files, don't rename them - best compromise for safety.
        vc-make-backup-files t         ; Even backup files under version control
        )
#+end_src
*** Dired

*** [[https://www.emacswiki.org/emacs/SaveHist][savehist]]

Save the minibuffer history.

#+begin_src emacs-lisp :name savehist
  (setq savehist-file (expand-file-name "savehist" deftpunk--var-dir)
        history-length 100
        history-delete-duplicates t
        savehist-save-minibuffer-history t
        savehist-additional-variables '(kill-ring
                                        search-ring
                                        mark-ring
                                        global-mark-ring
                                        regexp-search-ring
                                        extended-command-history
                                        regexp-search-ring))
  (savehist-mode 1)

  ;; Limit some of the items in savehist
  (put 'savehist-minibuffer-history-variables 'history-length 50)
  (put 'org-read-date-history                 'history-length 50)
  (put 'read-expression-history               'history-length 50)
  (put 'org-table-formula-history             'history-length 50)
  (put 'extended-command-history              'history-length 50)
  (put 'ido-file-history                      'history-length 50)
  (put 'helm-M-x-input-history                'history-length 50)
  (put 'minibuffer-history                    'history-length 50)
  (put 'ido-buffer-history                    'history-length 50)
  (put 'buffer-name-history                   'history-length 50)
  (put 'file-name-history                     'history-length 50)
#+end_src
*** [[https://www.emacswiki.org/emacs/SavePlace][saveplace]]

Remembering the last place you visited in a file.

#+begin_src emacs-lisp :name saveplace
  (setq save-place-file (expand-file-name "emacs-places" deftpunk--var-dir)
        save-place-forget-unreadable-files nil  ; Setting to t has the potential to make exiting slow
        )
  (save-place-mode 1)
  (add-hook 'save-place-find-file-hook 'recenter)
  (add-hook 'find-file-hook 'save-place-find-file-hook t)
#+end_src

** Org

*** Configuration

#+begin_src emacs-lisp :name OrgConfiguration
  ;; Make all the lines soft-wrap
  (use-package org
    :elpaca nil
    :blackout (org-mode . " Org")
    :hook (org-mode . (lambda ()
                        (toggle-truncate-lines nil)))
    :general
    (:keymaps 'org-mode-map
              "C-c C-'" 'org-edit-special)
    :init
    (setq org-use-speed-commands t                ; faster navigation
          org-fontify-quote-and-verse-blocks t    ; quote/verse blocks show up better
          org-return-follows-link t
          org-src-fontify-natively t
          org-startup-indented t
          org-pretty-entities t
          org-hide-emphasis-markers t       ; show italicized text instead of /italicized text/
          org-startup-with-inline-images t
          org-image-actual-width '(300)
          ))

  ;; More "keep off my modeline"
  (with-eval-after-load 'org-indent
    (blackout 'org-indent-mode))
#+end_src

*** [[https://github.com/yilkalargaw/org-auto-tangle][org-auto-tangle]]

Automatically tangle your org files if you have =#+auto_tangle: t= in your org file. This is mainly for this Org config file.

Bonus: The tangle is async.

#+begin_src emacs-lisp :org-auto-tangle
  (use-package org-auto-tangle
    :hook (org-mode . org-auto-tangle-mode))

  ;; The joys of hooks and loading.
  (with-eval-after-load 'org-auto-tangle
    (blackout 'org-auto-tangle-mode))
#+end_src

*** [[https://github.com/minad/org-modern][org-modern]]

Implements a "modern" style for Org buffers.

#+begin_src emacs-lisp :name org-modern
  ;; https://github.com/minad/org-modern/issues/106#issuecomment-1344659316
  ;; Fixes issue mentioned above
  (defun disable-point-adjustment (&rest args)
    (setq disable-point-adjustment t))
  (advice-add 'org-beginning-of-line :after #'disable-point-adjustment)

  (use-package org-modern
    :blackout
    :after org
    :init
    (setq org-modern-hide-stars nil
          ;; I prefer just the circle
          org-modern-star '("○" "○" "○" "○" "○" "○")
          org-auto-align-tags nil
          org-tags-column 0
          org-catch-invisible-edits 'show-and-error
          org-special-ctrl-a/e t
          org-insert-heading-respect-content t

          ;; Org styling, hide markup etc.
          org-ellipsis "…"

          ;; Agenda styling
          org-agenda-tags-column 0
          org-agenda-block-separator ?─
          org-agenda-time-grid
          '((daily today require-timed)
            (800 1000 1200 1400 1600 1800 2000)
            " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
          org-agenda-current-time-string
          "⭠ now ─────────────────────────────────────────────────")
    :config
    (global-org-modern-mode))
#+end_src

** Source Control

*** [[https://gitlab.com/pidu/git-timemachine][git-timemachine]]

Step through historic versions of a git controlled file.

Visit a git-controlled file and issue M-x git-timemachine (or bind it to a keybinding of your
choice). If you just need to toggle the time machine you can use M-x git-timemachine-toggle.

Use the following keys to navigate historic version of the file

p Visit previous historic version
n Visit next historic version
w Copy the abbreviated hash of the current historic version
W Copy the full hash of the current historic version
g Goto nth revision
t Goto revision by selected commit message
q Exit the time machine.
b Run magit-blame on the currently visited revision (if magit available).
c Show current commit using magit (if magit available).

#+begin_src emacs-lisp :name git-timemachine
    (use-package git-timemachine
      :config
      (setq git-timemachine-abbreviation-length 14
            git-timemachine-show-minibuffer-details t)
      (elpaca-wait))

    ;; TODO: Make this cribbing from DOOM Emacs work properly.
    ;; (require 'magit-blame)
    ;; ;; Sometimes I forget `git-timemachine' is enabled in a buffer, so instead of
    ;; ;; showing revision details in the minibuffer, show them in
    ;; ;; `header-line-format', which has better visibility.
    ;; (setq git-timemachine-show-minibuffer-details nil)
    ;; (add-hook 'git-timemachine-mode-hook #'+vcs|init-header-line)
    ;; (advice-add #'git-timemachine-show-revision :after #'+vcs*update-header-line)

    ;; From redguardtoo - http://blog.binchen.org/posts/new-git-timemachine-ui-based-on-ivy-mode.html
    (defun my-git-timemachine-show-selected-revision ()
      "Show last (current) revision of file."
      (interactive)
      (let (collection)
        (setq collection
              (mapcar (lambda (rev)
                        ;; re-shape list for the ivy-read
                        (cons (concat (substring (nth 0 rev) 0 7) "|" (nth 5 rev) "|" (nth 6 rev)) rev))
                      (git-timemachine--revisions)))
        (ivy-read "commits:"
                  collection
                  :action (lambda (rev)
                            (git-timemachine-show-revision rev)))))

    (defun my-git-timemachine ()
      "Open git snapshot with the selected version.  Based on ivy-mode."
      (interactive)
      (unless (featurep 'git-timemachine)
        (require 'git-timemachine))
      (git-timemachine--start #'my-git-timemachine-show-selected-revision))
#+end_src

*** [[https://magit.vc/][Magit]] & Forge

The absolutely best git porcelain on Planet Earth.

Some more informational links:
https://emacsair.me/2017/09/01/magit-walk-through/
https://emacsair.me/2017/09/01/the-magical-git-interface/
https://www.masteringemacs.org/article/introduction-magit-emacs-mode-git

#+begin_src emacs-lisp :name magit
  (use-package magit
    :defer t
    :commands (magit-dispatch)
    :general
    (:prefix "C-x"
             "g" 'magit)
    :hook (git-commit-setup-hook . git-commit-turn-on-flyspell)
    :init
    (if IS-MAC
        (setq magit-git-executable "/opt/homebrew/bin/git")
      (setq magit-git-executable "/usr/local/bin/git"))
    :config
    ;; Add git-timemachine to the magit-dispatch transient map.
    (transient-append-suffix 'magit-dispatch '(0 -1 -1) '("S" "git timemachine" git-timemachine))

    (setq  magit-log-arguments '("--graph" "--decorate" "--color")
           magit-revert-buffers 'silent
           magit-revision-show-gravatars '("^Author:     " . "^Commit:     ")
           magit-diff-refine-hunk t ; show granular diffs in selected hunk
           ;; Don't autosave repo buffers. This is too magical, and saving can
           ;; trigger a bunch of unwanted side-effects, like save hooks and
           ;; formatters. Trust us to know what we're doing.
           magit-save-repository-buffers nil))

  (use-package forge
    :after magit)
#+end_src

TODO: Another codereview from magit tool https://github.com/blahgeek/emacs-pr-review for doing reviews with GitHub
TODO: fixes code-review: https://github.com/wandersoncferreira/code-review/pull/246#issuecomment-1867538123

** General Software Development
*** lispy

** Keybindings and related functionality

*** Matching parens ala %

#+begin_src emacs-lisp :name matching-parens
  ;; Trying out matching parens
  ;; https://www.gnu.org/software/emacs/manual/html_node/efaq/Matching-parentheses.html
  (defun match-paren (arg)
    "Go to the matching paren if on a paren; otherwise insert %."
    (interactive "p")
    (cond ((looking-at "\\s(") (forward-list 1) (backward-char 1))
          ((looking-at "\\s)") (forward-char 1) (backward-list 1))
          (t (self-insert-command (or arg 1)))))

  (global-set-key "%" 'match-paren)
#+end_src

*** Making escape do more quiting.

I might as well take advantage of my Neovim habit.

#+begin_src emacs-lisp :name escape
  ;; Some final remapping of Escape to "Quit"

  (global-set-key (kbd "<escape>") 'keyboard-quit)

  ;; When C-g gets rebound.
  (define-key key-translation-map (kbd "ESC") (kbd "C-g"))

  (define-key minibuffer-local-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-ns-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-completion-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-must-match-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-isearch-map [escape] 'minibuffer-keyboard-quit)
#+end_src
