#+title Deftpunk Emacs
#+author: Erick Bodine <erick.bodine@gmail.com>
#+property: header-args :tangle "/Users/bodine/MyStuff/dftpunk-emacs/init.el"
#+startup: content
#+auto_tangle: t

* About

My version of Emacs for MacOS - an attempt to be more minimalistic &
use builtin functionality.  All of which is, of course, relative.

** Installation

My notes for installing from scratch.

Dependencies:
- zsh + oh-my-zsh
- git
- delta
- ripgrep
- cmake   -> for compiling libvterm
- building emacs-lsp-booster
  - clone the repo
  - update Rust toolchain -> rustup update
  - cargo build --release
  - cp target/release/emacs-lsp-booster to $PATH

GPG:
- brew install gpg2 pinentry-mac
- add =pinentry-program /opt/homebrew/bin/pinentry-mac= to ~//.gnupg/gpg-agent.conf
- =killall gpg-agent=

I am using emacs-plus: https://github.com/d12frosted/homebrew-emacs-plus

1. brew tap d12frosted/emacs-plus
2. brew install emacs-plus@29 --with-imagemagick --with-native-comp --with-poll

Clone this dotfiles repository.

Run =emacs --quick --script ~/.emacs.d/scripts/get-env.el= to generate the environment variables file.

* Early-Init
:properties:
:header-args: :tangle "/Users/bodine/MyStuff/dftpunk-emacs/early-init.el"
:end:
#+name: early-init-header-block
#+begin_src emacs-lisp :exports none
;;; early-init.el --- deftpunk early-init file. -*- lexical-binding: t; buffer-read-only: t -*-
;;;
;;; Commentary:
;;; This file was automatically generated by `org-babel-tangle'.
;;; Do not change this file.  Main config is located in emacs.d/dftpnk-emacs.org
;;;
;;; Code:
#+end_src

** Startup message & avoid flash of light

#+begin_src emacs-lisp :name startup-hook
  ;; Time how long Emacs starts up.
  ;; Use a hook so the message doesn't get clobbered by other messages.
  (add-hook 'emacs-startup-hook
            (lambda ()
              (message "Emacs ready in %s with %d garbage collections."
                       (format "%.2f seconds"
                               (float-time
                                (time-subtract after-init-time before-init-time)))
                       gcs-done)))

  ;; Uncomment and run use-package-report to get a basic profile of how long packages are taking to run.
  (setq use-package-compute-statistics t)

  ;; https://github.com/LionyxML/lemacs/blob/995924f3aea3793e8a729b3a00f4a63ff2630274/early-init.el#L7
  (defun lemacs/avoid-initial-flash-of-light ()
    "Avoid flash of light when starting Emacs."
    (setq mode-line-format nil)
    ;; These colors should match your selected theme for maximum effect
    ;; Note that for catppuccin whenever we create a new frame or open it on terminal
    ;; it is necessary to reload the theme.
    (set-face-attribute 'mode-line nil :background "#1E1E2D" :foreground "#1E1E2D" :box 'unspecified))

  (lemacs/avoid-initial-flash-of-light)
#+end_src

** Environmental variables

Using a different methology instead of exec-path-from-shell to set environment variables.

https://roamingbytes.substack.com/p/emacs-on-macos-preserving-the-correct-environment-1735d2e8cb88
https://github.com/doomemacs/doomemacs/blob/master/lisp/cli/env.el#L53

A modest gist of bash/zsh shell configuration on MacOS from the perspective of setting PATH.
https://gist.github.com/Linerre/f11ad4a6a934dcf01ee8415c9457e7b2

#+begin_src emacs-lisp :name environment-setup
  (defun load-env-file (file)
    "Read and set envvars from FILE."
    (if (null (file-exists-p file))
        (signal 'file-error
                (list "No envvar file exists." file
                      "Run `emacs --quick --script ~/.emacs.d/scripts/gen-env-file.el` from a terminal."))
      (with-temp-buffer
        (insert-file-contents file)
        (when-let (env (read (current-buffer)))
          (let ((tz (getenv-internal "TZ")))
            (setq-default process-environment (append env (default-value 'process-environment))
                          exec-path (append (split-string (getenv "PATH") path-separator t)
                                            (list exec-directory))
                          shell-file-name (or (getenv "SHELL") (default-value 'shell-file-name)))
            (when-let (newtz (getenv-internal "TZ"))
              (unless (equal tz newtz)
                (set-time-zone-rule newtz))))
          env))))

  (load-env-file "~/.emacs.d/var/env.el")

  ;; Mostly prevents libgccjit errors; manually setting to the latest gcc path is brittle.
  ;; I had to update the path below to the latest gcc/libgccjit, uninstall/re-install emacs-plus, then run `emacs -nw` to get the native-comp to work properly.
  ;; Solution found at: https://github.com/d12frosted/homebrew-emacs-plus/issues/554
  (setenv "LIBRARY_PATH"
          (string-join
           '("/opt/homebrew/lib/gcc/current"
             "/opt/homebrew/opt/libgccjit/lib/gcc/14"
             "/opt/homebrew/opt/gcc/lib/gcc/14/gcc/aarch64-apple-darwin21/14")
           ":"))

  ;; Use plists for deserialization for lsp-mode
  (setenv "LSP_USE_PLISTS" "true")
#+end_src

** Adjust garbage collection & other startup/performance optimizations

You'll see this modification in many config files around the internet. The idea is that emacs sets it's memory
threshold 40 years in the past. This causes the garbage collector to run frequently and can cause delays or
muck up the speed of your setup. We pretty much disable garbage collection during the initial phase to improve
our startup time. After we have given enough time for everything to load we then set the gc-theshold to a
reasonable number. Sometimes people set the threshold back to its default value, but I keep it a little higher
to handle things like fuzzy completion and language-server requirements. (See also GCMH Mode)

Some of the things in here may be cargo culting so .... caveat emptor.

#+begin_src emacs-lisp :name garbage-collection

  (defvar default-file-name-handler-alist file-name-handler-alist)
  (defvar extended-gc-cons-threshold most-positive-fixnum)
  (defvar default-gc-cons-threshold (* 100 1024 1024))

  ;; Native Compilation Vars
  (when (featurep 'native-compile)
    (setq native-comp-speed 2
          native-comp-async-report-warnings-errors nil
          native-comp-deferred-compilation t)
    ;; Set the right directory to store the native compilation cache
    ;; NOTE the method for setting the eln-cache directory depends on the emacs version
    (when (fboundp 'startup-redirect-eln-cache)
      (if (version< emacs-version "29")
          (add-to-list 'native-comp-eln-load-path (convert-standard-filename (expand-file-name "var/eln-cache/" user-emacs-directory)))
        (startup-redirect-eln-cache (convert-standard-filename (expand-file-name "var/eln-cache/" user-emacs-directory))))))

  (setq-default bidi-display-reordering 'left-to-right
                bidi-paragraph-direction 'left-to-right
                frame-inhibit-implied-resize t
                inhibit-default-init t
                site-run-file nil
                load-prefer-newer t)

  ;; 02/28/24 19:36:07
  ;; Looks like read-process-output-max can't be fine tuned on MacOS.  Its stuck at 64kb.  Maybe the patch to Emacs30 will help(?).
  ;; https://github.com/emacs-lsp/lsp-mode/discussions/3561
  ;; (read-process-output-max (* 1024 1024 3))

  (setq file-name-handler-alist nil
        package-enable-at-startup nil
        gc-cons-threshold extended-gc-cons-threshold)

  (defun arco/return-gc-to-default ()
    (setq-default gc-cons-threshold default-gc-cons-threshold
                  load-prefer-newer nil))

  (defun arco/reset-file-handler-alist-h ()
    (dolist (handler file-name-handler-alist)
      (add-to-list 'default-file-name-handler-alist handler))
    (setq file-name-handler-alist default-file-name-handler-alist))

  (defun deftpunk/startup-time ()
    "Display garbage collections and startup time."
    (let ((garbage-collection-messages t)) (garbage-collect))
    (let ((msg (format "started (%d) in %s" (emacs-pid) (emacs-init-time))))
      (message (concat "emacs: " msg))))

  (add-hook 'after-init-hook #'arco/reset-file-handler-alist-h)
  (add-hook 'after-init-hook #'arco/return-gc-to-default)
  (add-hook 'after-init-hook #'deftpunk/startup-time)
  (advice-add #'package--ensure-init-file :override #'ignore)

  ;; Prevent unwanted runtime builds in gccemacs (native-comp); packages are
  ;; compiled ahead-of-time when they are installed and site files are compiled
  ;; when gccemacs is installed.
  (setq comp-deferred-compilation nil)

  ;; remove searching for .gz files, as all my packages are uncompressed
  ;; this halves how many files emacs tries to open (if you have a lot of
  ;; packages, emacs executes a lot of failing file opens)
  (setq jka-compr-load-suffixes nil)
  (jka-compr-update)
#+end_src

** Pre-Gui Configuration & Optimization

Ever since Emacs 27.0 we can utilize the early-init file to setup a few graphical settings without seeing a
major slow down. The biggest speed ups I've seen from this is setting =vertical-scroll-bars= , =ns-appearance=,
and =ns-transparent-titlebar=.  We also handle a few other graphical settings.

#+begin_src emacs-lisp :name gui-optimization
  ;; Some nice UI tweaks that improve performance when specified
  ;; in early-init.el
  (modify-all-frames-parameters '((width . 105)
                                  (height . 100)
                                  (left . 0)
                                  (right . 0)
                                  (internal-border-width . 1)
                                  (vertical-scroll-bars . nil)
                                  (tool-bar-lines . 0)
                                  (ns-appearance . dark)
                                  ))

  ;; Prevent the glimpse of un-styled Emacs by disabling these UI elements early.
  (push '(menu-bar-lines . 0) default-frame-alist)
  (push '(tool-bar-lines . 0) default-frame-alist)
  (push '(vertical-scroll-bars) default-frame-alist)

  ;; Resizing the Emacs frame can be a terribly expensive part of changing the
  ;; font. By inhibiting this, we easily halve startup times with fonts that are
  ;; larger than the system default.
  (setq frame-inhibit-implied-resize t)

  ;; Get rid of any window chrome.
  (when window-system
    (menu-bar-mode -1)
    (tool-bar-mode -1)
    (scroll-bar-mode -1)
    (tooltip-mode -1))
  (setq inhibit-splash-screen t)
  (setq use-file-dialog nil)

  ;; Want square corners when no titlebars
  ;; 2023-08-11T22:19:27 > this looks funky w/out a tiling window manager.
  ;; (add-to-list 'default-frame-alist '(undecorated . t))

  (setq frame-resize-pixelwise t
        frame-inhibit-implied-resize t)

#+end_src

** UTF-8

Set everything to UTF-8

#+begin_src emacs-lisp :name utf-8
  (setq default-input-method nil
        utf-translate-cjk-mode nil)
  (set-language-environment 'utf-8)

  ;; Make UTF-8 the default coding system.
  (when (fboundp 'set-charset-priority)
    (set-charset-priority 'unicode))
  (prefer-coding-system 'utf-8)
  (setq locale-coding-system 'utf-8
        selection-coding-system 'utf-8)

  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-selection-coding-system 'utf-8)
  (prefer-coding-system 'utf-8)
#+end_src

** Bonus keys

This allows us of C-i, C-m & C-[ ... you know, like other editors can.
https://emacsnotes.wordpress.com/2022/09/11/three-bonus-keys-c-i-c-m-and-c-for-your-gui-emacs-all-with-zero-headache/

#+begin_src emacs-lisp :name bonus-keys
  (add-hook
   'after-make-frame-functions
   (defun setup-blah-keys (frame)
     (with-selected-frame frame
       (when (display-graphic-p) ; don't remove this condition, if you want
                                          ; terminal Emacs to be usable
         ;; - When you type `Ctrl-i', Emacs see it as `BLAH-i', and NOT as 'Tab'
         ;; - When you type `Ctrl-m', Emacs see it as `BLAH-m', and NOT as 'Return'
         ;; - When you type `Ctrl-[', Emacs see it as `BLAH-lsb', and not as 'Esc'.
         ;;
         ;; That is,
         ;;
         ;; - `Ctrl-i' and 'Tab' keys are different
         ;; - `Ctrl-m' and 'Return' keys are different
         ;; - `Ctrl-[' and 'Esc' keys are different
         ;;
         ;; The three BLAH keys are the bonus keys.
         (define-key input-decode-map (kbd "C-i") [BLAH-i])
         (define-key input-decode-map (kbd "C-[") [BLAH-lsb]) ; left square bracket
         (define-key input-decode-map (kbd "C-m") [BLAH-m])
         ;; You can replace `BLAH-' above with `C-' or
         ;; `CONTROL-', it doesnt' matter.
         ;;
         ;; BLAH is merely a symbol / name; feel free to change
         ;; it to whatever you like .
         ))))
#+end_src

** Early key unset/set

#+begin_src emacs-lisp :name unset-set-keys
  ;; Unbind some Super keys on my Mac
  (global-unset-key (kbd "s-a"))
  (global-unset-key (kbd "s-d"))
  (global-unset-key (kbd "s-f"))
  (global-unset-key (kbd "s-g"))
  (global-unset-key (kbd "s-h"))
  (global-unset-key (kbd "s-i"))
  (global-unset-key (kbd "s-j"))
  (global-unset-key (kbd "s-k"))
  (global-unset-key (kbd "s-m"))
  (global-unset-key (kbd "s-o"))
  (global-unset-key (kbd "s-p"))
  (global-unset-key (kbd "s-s"))
  (global-unset-key (kbd "s-t"))
  (global-unset-key (kbd "s-u"))
  (global-unset-key (kbd "s-w"))
  (global-unset-key (kbd "s-y"))
#+end_src

#+name: early-init-footer-block
#+begin_src emacs-lisp :exports none
(provide 'early-init)
;;; early-init.el ends here
#+end_src

* Init
#+name: init-header-block
#+begin_src emacs-lisp :exports none
;;; init.el --- deftpunk Emacs config file -*- lexical-binding: t; buffer-read-only: t -*-
;;;
;;; Commentary:
;;; Emacs `init.el' config for deftpunk
;;; This file was automatically generated by `org-babel-tangle'.
;;; Do not change this file.  Main config is located in emacs.d/deftpunk-emacs.org
;;;
;;; Code:
#+end_src

** Set some deftpunk variables

=etc/= - For files & directories that we save across systems, e.g. dictionaries, abbreviations
=var/= - For files & directories that are local, e.g. caches, backups

#+begin_src emacs-lisp :name globals

  (defconst deftpunk--emacs-dir (file-truename "~/.emacs.d")
    "The path to the emacs.d directory")

  (defconst deftpunk--org-configuration-file (concat deftpunk--emacs-dir "/deftpunk-emacs.org")
    "The Org mode literate configuration file.")

  (defconst deftpunk--etc-dir (concat deftpunk--emacs-dir "/etc/")
    "Location for files to save across systems.")

  (defconst deftpunk--var-dir (concat deftpunk--emacs-dir "/var/")
    "Location for cache & files that we don't save across systems.")

  ;; I use Mac & occasionally Linux, no Windoze.
  (defconst IS-MAC (eq system-type 'darwin))
  (defconst IS-LINUX (eq system-type 'gnu/linux))
#+end_src

** Package Management

Starting to use elpaca with =use-package= instead of straight for package management.

Type =M-x elpaca-manager= to search, get info, etc.

*** [[https://github.com/progfolio/elpaca][elpaca]]

The Basics: https://www.youtube.com/watch?v=5Ud-TE3iIQY

#+begin_src emacs-lisp :name elpaca
  (defvar elpaca-installer-version 0.7)
  (defvar elpaca-directory (expand-file-name "elpaca/" deftpunk--var-dir))
  (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
  (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
  (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                                :ref nil
                                :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                                :build (:not elpaca--activate-package)))
  (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
         (build (expand-file-name "elpaca/" elpaca-builds-directory))
         (order (cdr elpaca-order))
         (default-directory repo))
    (add-to-list 'load-path (if (file-exists-p build) build repo))
    (unless (file-exists-p repo)
      (make-directory repo t)
      (when (< emacs-major-version 28) (require 'subr-x))
      (condition-case-unless-debug err
          (if-let ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                   ((zerop (call-process "git" nil buffer t "clone"
                                         (plist-get order :repo) repo)))
                   ((zerop (call-process "git" nil buffer t "checkout"
                                         (or (plist-get order :ref) "--"))))
                   (emacs (concat invocation-directory invocation-name))
                   ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                         "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                   ((require 'elpaca))
                   ((elpaca-generate-autoloads "elpaca" repo)))
              (progn (message "%s" (buffer-string)) (kill-buffer buffer))
            (error "%s" (with-current-buffer buffer (buffer-string))))
        ((error) (warn "%s" err) (delete-directory repo 'recursive))))
    (unless (require 'elpaca-autoloads nil t)
      (require 'elpaca)
      (elpaca-generate-autoloads "elpaca" repo)
      (load "./elpaca-autoloads")))
  (add-hook 'after-init-hook #'elpaca-process-queues)
  (elpaca `(,@elpaca-order))

  ;; Install a package via the elpaca macro
  ;; See the "recipes" section of the manual for more details.

  ;; (elpaca example-package)

  ;; Install use-package support
  (elpaca elpaca-use-package
    ;; Enable :elpaca use-package keyword.
    (elpaca-use-package-mode)
    ;; Assume :elpaca t unless otherwise specified.
    (setq elpaca-use-package-by-default t))

  ;; Block until current queue processed.
  (elpaca-wait)

  ;;When installing a package which modifies a form used at the top-level
  ;;(e.g. a package which adds a use-package key word),
  ;;use `elpaca-wait' to block until that package has been installed/configured.
  ;;For example:
  ;;(use-package general :demand t)
  ;;(elpaca-wait)

  ;; Expands to: (elpaca evil (use-package evil :demand t))
  ;; (use-package evil :demand t)

  ;;Turns off elpaca-use-package-mode current declaration
  ;;Note this will cause the declaration to be interpreted immediately (not deferred).
  ;;Useful for configuring built-in emacs features.
  ;; (use-package emacs :elpaca nil :config (setq ring-bell-function #'ignore))

  ;; Don't install anything. Defer execution of BODY
  ;; (elpaca nil (message "deferred"))
#+end_src

*** [[https://github.com/noctuid/general.el][General]]

Better manage some keybindings.

#+begin_src emacs-lisp :name general.el
  (use-package general)

  (elpaca-wait)

  ;; Leader key
  (general-create-definer deftpunk-leader-def
    :keymaps 'override
    :prefix "s-SPC")

  ;; local leader
  ;; This allows for finer granularity than hydra-major-mode by binding to individual key maps.
  (general-create-definer deftpunk-local-leader-def
    :keymaps 'override
    :prefix "C-;")
#+end_src

*** [[https://github.com/radian-software/blackout][Blackout]]

Clean up the modeline.  Adds =:blackout= to =use-package= declarations.

#+begin_src emacs-lisp :name blackout
  (use-package blackout)
  (elpaca-wait)
#+end_src

*** [[https://github.com/ajgrf/on.el][on.el]]

Some utility hooks and functions from Doom Emacs.

Hooks:
=on-first-input= - eg. delay loading which-key-mode until the 1st keys is pressed.
=on-first-file=
=on-first-buffer=
=on-init-ui=
=on-switch-buffer=
=on-switch-frame=
=on-switch-window=

#+begin_src emacs-lisp :name on.el
  (use-package on
    :ensure (:host github :repo "ajgrf/on.el")
    :config
    (elpaca-wait)
    (require 'on))
#+end_src

*** [[https://github.com/justbur/emacs-which-key][which-key]]

Display keybindings following your prefix command in a popup.

TODO: the which-key-show-toplevel binding doesn't work
(global-set-key (kbd "C-h <BLAH-m>") 'which-key-show-toplevel)
Autoloading file /Users/bodine/MyStuff/dftpunk-emacs/var/elpaca/builds/which-key/which-key.elc failed to define function which-key-show-toplevel

#+begin_src emacs-lisp :name which-key
  (use-package which-key
    :blackout
    :commands (which-key-mode which-key-show-toplevel)
    :hook (on-first-input . which-key-mode)
    :custom
    (which-key-enable-exteded-define-key t)
    (which-key-idle-delay 0.5)
    :config
    (elpaca-wait)
    (which-key-mode +1))
#+end_src

*** [[https://github.com/abo-abo/hydra][hydra]]

Use hydra for repeating keys.

#+begin_src emacs-lisp :name hydra
  (use-package hydra)
  (elpaca-wait)
#+end_src

*** [[https://github.com/jerrypnz/major-mode-hydra.el][major-mode-hydra]]

 Major Mode Hydra & Pretty Mode Hydra

- pretty-hydra provides a macro pretty-hydra-define to make it easy to create
  hydras with a pretty table layout with some other bells and whistles
- Based on pretty-hydra, major-mode-hydra allows you to create pretty hydras
  with a similar API and summon them with the same key across different major
  modes.

unicode box characters: https://en.wikipedia.org/wiki/Box-drawing_character

#+BEGIN_SRC emacs-lisp :name major-mode-hydra
  (use-package major-mode-hydra
  ;  :straight (major-mode-hydra :type git :host github :repo "jerrypnz/major-mode-hydra.el")
    :init
    ;; Set the default major-mode-hydra title using all-the-icons icon
    ;; for the major mode.  THis is just in case we don't use any of the
    ;; "with=*" functions below.
    (setq major-mode-hydra-title-generator
      '(lambda (mode)
         (s-concat "\n"
                   (s-repeat 10 " ")
                   (all-the-icons-icon-for-mode mode :v-adjust 0.05)
                   " "
                   (symbol-name mode)
                   ""))))

  ;; A bunch of utility functions from https://gist.github.com/mbuczko/e15d61363d31cf78ff17427072e0c325
  (defun with-faicon (icon str &optional height v-adjust)
    (s-concat (all-the-icons-faicon icon :v-adjust (or v-adjust 0) :height (or height 1)) " " str))

  (defun with-fileicon (icon str &optional height v-adjust)
    (s-concat (all-the-icons-fileicon icon :v-adjust (or v-adjust 0) :height (or height 1)) " " str))

  (defun with-octicon (icon str &optional height v-adjust)
    (s-concat (all-the-icons-octicon icon :v-adjust (or v-adjust 0) :height (or height 1)) " " str))

  (defun with-material (icon str &optional height v-adjust)
    (s-concat (all-the-icons-material icon :v-adjust (or v-adjust 0) :height (or height 1)) " " str))

  (defun with-mode-icon (mode str &optional height nospace face)
    (let* ((v-adjust (if (eq major-mode 'emacs-lisp-mode) 0.0 0.05))
           (args     `(:height ,(or height 1) :v-adjust ,v-adjust))
           (_         (when face
                        (lax-plist-put args :face face)))
           (icon     (apply #'all-the-icons-icon-for-mode mode args))
           (icon     (if (symbolp icon)
                         (apply #'all-the-icons-octicon "file-text" args)
                       icon)))
      (s-concat icon (if nospace "" " ") str)))
#+END_SRC

*** transient

#+begin_src emacs-lisp :name transient
  (use-package transient :ensure t)
  (elpaca-wait)
#+end_src

** Some useful functions

#+begin_src emacs-lisp :name some-macros-and-functions
  ;;; Some convenience macros from our favorite martian - Doom Emacs creator Henrik Lissner ;;;

  ;; 4/22/2020 - In after! below, I removed the check to see if the package was
  ;; in the list of doom-disabled-packages
  (defmacro after! (package &rest body)
    "Evaluate BODY after PACKAGE have loaded.

      PACKAGE is a symbol or list of them. These are package names, not modes,
      functions or variables. It can be:

      - An unquoted package symbol (the name of a package)
          (after! helm BODY...)
      - An unquoted list of package symbols (i.e. BODY is evaluated once both magit
        and git-gutter have loaded)
          (after! (magit git-gutter) BODY...)
      - An unquoted, nested list of compound package lists, using any combination of
        :or/:any and :and/:all
          (after! (:or package-a package-b ...)  BODY...)
          (after! (:and package-a package-b ...) BODY...)
          (after! (:and package-a (:or package-b package-c) ...) BODY...)
        Without :or/:any/:and/:all, :and/:all are implied.

      This is a wrapper around `eval-after-load' that:

      1. Suppresses warnings for disabled packages at compile-time
      2. No-ops for package that are disabled by the user (via `package!')
      3. Supports compound package statements (see below)
      4. Prevents eager expansion pulling in autoloaded macros all at once"
    (declare (indent defun) (debug t))
    (if (symbolp package)
        (list (if (or (not (bound-and-true-p byte-compile-current-file))
                      (require package nil 'noerror))
                  #'progn
                #'with-no-warnings)
              (let ((body (macroexp-progn body)))
                `(if (featurep ',package)
                     ,body
                   ;; We intentionally avoid `with-eval-after-load' to prevent
                   ;; eager macro expansion from pulling (or failing to pull) in
                   ;; autoloaded macros/packages.
                   (eval-after-load ',package ',body))))
      (let ((p (car package)))
        (cond ((not (keywordp p))
               `(after! (:and ,@package) ,@body))
              ((memq p '(:or :any))
               (macroexp-progn
                (cl-loop for next in (cdr package)
                         collect `(after! ,next ,@body))))
              ((memq p '(:and :all))
               (dolist (next (cdr package))
                 (setq body `((after! ,next ,@body))))
               (car body))))))

  (defmacro appendq! (sym &rest lists)
    "Append LISTS to SYM in place."
    `(setq ,sym (append ,sym ,@lists)))

  ;; TODO: Need the doom-enlist function definition for this to work.
  ;;  (defmacro defadvice! (symbol arglist &optional docstring &rest body)
  ;;    "Define an advice called SYMBOL and add it to PLACES.
  ;;
  ;;    ARGLIST is as in `defun'. WHERE is a keyword as passed to `advice-add', and
  ;;    PLACE is the function to which to add the advice, like in `advice-add'.
  ;;    DOCSTRING and BODY are as in `defun'.
  ;;
  ;;    \(fn SYMBOL ARGLIST &optional DOCSTRING &rest [WHERE PLACES...] BODY\)"
  ;;    (declare (doc-string 3) (indent defun))
  ;;    (unless (stringp docstring)
  ;;      (push docstring body)
  ;;      (setq docstring nil))
  ;;    (let (where-alist)
  ;;      (while (keywordp (car body))
  ;;        (push `(cons ,(pop body) (doom-enlist ,(pop body)))
  ;;              where-alist))
  ;;      `(progn
  ;;         (defun ,symbol ,arglist ,docstring ,@body)
  ;;         (dolist (targets (list ,@(nreverse where-alist)))
  ;;           (dolist (target (cdr targets))
  ;;             (advice-add target (car targets) #',symbol))))))
  ;;
  ;;  (defmacro delq! (elt list &optional fetcher)
  ;;    "`delq' ELT from LIST in-place.
  ;;      If FETCHER is a function, ELT is used as the key in LIST (an alist)."
  ;;    `(setq ,list
  ;;           (delq ,(if fetcher
  ;;                      `(funcall ,fetcher ,elt ,list)
  ;;                    elt)
  ;;                 ,list)))

  ;; There are certain buffers I don't want to delete on accident.
  ;; Code taken from https://github.com/rememberYou/.emacs.d/blob/master/config.org
  (defvar *protected-buffers* '("*scratch*" "*Messages*"))

  (defun arco/protected-buffers ()
    "Protects some buffers from being killed."
    (dolist (buffer *protected-buffers*)
      (if (get-buffer buffer)
          (with-current-buffer buffer
            (emacs-lock-mode 'kill))
        (get-buffer-create buffer)
        (with-current-buffer buffer
          (emacs-lock-mode 'kill)))))

  (general-add-hook 'emacs-startup-hook #'arco/protected-buffers)

    ;;;###autoload
  ;; https://stackoverflow.com/questions/251908/how-can-i-insert-current-date-and-time-into-a-file-using-emacs
  (defun today ()
    "Insert string for today's date nicely formatted in American style,
    e.g. Sunday, September 17, 2000."
    (interactive)                 ; permit invocation in minibuffer
    (insert (format-time-string "%A, %B %e, %Y")))

    ;;;###autoload
  (defun flex//kill-current-buffer ()
    "What it says."
    (interactive)
    (kill-buffer (current-buffer)))

  (defun vim-return ()
    "Still want Return to do the right thing in dired mode."
    (interactive)
    (if (eq major-mode 'dired-mode)
        (dired-find-file)
      (progn
        (next-line)
        (back-to-indentation-or-beginning))))

  ;; not broken, toggle letter case from
  ;; http://ergoemacs.org/emacs/modernization_upcase-word.html][xah]] originally.
  ;; http://stackoverflow.com/questions/18257573/how-to-toggle-letter-cases-in-a-region-in-emacs
  (defun toggle-letter-case ()
    "Toggle the letter case of current word or text selection.
     Toggles between: “all lower”, “Init Caps”, “ALL CAPS”."
    (interactive)
    (let (p1 p2 (deactivate-mark nil) (case-fold-search nil))
      (if (region-active-p)
          (setq p1 (region-beginning) p2 (region-end))
        (let ((bds (bounds-of-thing-at-point 'word) ) )
          (setq p1 (car bds) p2 (cdr bds)) ) )
      (when (not (eq last-command this-command))
        (save-excursion
          (goto-char p1)
          (cond
           ((looking-at "[[:lower:]][[:lower:]]") (put this-command 'state "all lower"))
           ((looking-at "[[:upper:]][[:upper:]]") (put this-command 'state "all caps") )
           ((looking-at "[[:upper:]][[:lower:]]") (put this-command 'state "init caps") )
           ((looking-at "[[:lower:]]") (put this-command 'state "all lower"))
           ((looking-at "[[:upper:]]") (put this-command 'state "all caps") )
           (t (put this-command 'state "all lower") ) ) ) )
      (cond
       ((string= "all lower" (get this-command 'state))
        (upcase-initials-region p1 p2) (put this-command 'state "init caps"))
       ((string= "init caps" (get this-command 'state))
        (upcase-region p1 p2) (put this-command 'state "all caps"))
       ((string= "all caps" (get this-command 'state))
        (downcase-region p1 p2) (put this-command 'state "all lower")) )
      ) )

  ;;
  (defun deftpunk/catch-error-p (func-symbol)
    "Call the passed function solely for the purpose of catching its error."
    (let (retval)
      (condition-case error
          (funcall func-symbol)
        ('error (setq retval error)))
      retval))

  ;; Full history of this function is foggy and lost to time.
  ;; https://stackoverflow.com/questions/234963/re-open-scratch-buffer-in-emacs
  (defun eme-goto-scratch ()
              "this sends you to the scratch buffer"
              (interactive)
              (let ((eme-scratch-buffer (get-buffer-create "*scratch*")))
      (switch-to-buffer eme-scratch-buffer)
      (lisp-interaction-mode)))

  ;; Some more excellence from karthinks.
  (defun repeated-prefix-help-command ()
    (interactive)
    (when-let* ((keys (this-command-keys-vector))
                (prefix (seq-take keys (1- (length keys))))
                (orig-keymap (key-binding prefix 'accept-default))
                (keymap (copy-keymap orig-keymap))
                (exit-func (set-transient-map keymap t #'which-key-abort)))
      (define-key keymap [remap keyboard-quit]
                  (lambda () (interactive) (funcall exit-func)))
      (which-key--create-buffer-and-show nil keymap)))
  (setq prefix-help-command #'repeated-prefix-help-command)

  ;; https://github.com/daut/dotfiles/blob/2ad4f5a5e0f1e786c91f17460d8599ec5d57318b/.emacs.d/init.el#L236C1-L241C47
  (defun daut/print-current-theme ()
    "Print the currently active theme."
    (interactive)
    (if custom-enabled-themes
        (message "Current theme: %s" (car custom-enabled-themes))
      (message "No theme is currently active")))
#+end_src

** Some initial packages and libraries

Packages and libraries that are dependencies elsewhere.

*** [[https://github.com/emacscollective/no-littering][no-littering]]

Helping keep my ~/.emacs.d clean.

#+begin_src emacs-lisp :name no-littering
  (use-package no-littering
    :custom
    (no-littering-etc-directory deftpunk--etc-dir)
    (no-littering-var-directory deftpunk--var-dir)
    (auto-save-file-name-transforms
     `((".*" ,(expand-file-name "auto-save/" no-littering-var-directory) t))))

  (elpaca-wait) ; So that other packages know where some Emacs system files are.
#+end_src

*** [[https://github.com/bbatsov/crux][crux]]

Some useful interactive commands from bbatsov

#+begin_src emacs-lisp :name crux
  (use-package crux
    :bind (("C-a" . crux-move-beginning-of-line)
           ("C-k" . crux-smart-kill-line)
           ("s-o" . crux-smart-open-line-above)
           ("s-RET" . crux-smart-open-line)))
#+end_src

*** [[https://github.com/joaotavora/yasnippet][yasnippet]] & [[https://github.com/AndreaCrotti/yasnippet-snippets][yasnippet-snippets]]

All of our snippet needs - the yasnippet [[http://joaotavora.github.io/yasnippet/][manual]].

Writing snippets: [[https://joaotavora.github.io/yasnippet/snippet-development.html][snippet-development]]

View available snippets for give mode: ~ya-visit-snippet-file~
Show list of available snippets & their trigger words: ~ya-describe-tables~
Reload all snippets: ~ya-reload-all~

#+begin_src emacs-lisp :name yasnippet
  (use-package yasnippet-snippets)

  (use-package yasnippet
    :hook (prog-mode-hook . yas-minor-mode)
    :custom
    (yas-verbosity 3)
    (yas-also-auto-indent-first-line t)
    :init
    ;; Remove default ~/.emacs.d/snippets
    ;; (defvar yas-snippet-dirs nil)

    :config
    ;; Allow private snippets.
    (add-to-list 'yas-snippet-dirs (expand-file-name "snippets" user-emacs-directory))
  ;; Only way I could get this to work.
  (require 'yasnippet)
  (yas-global-mode 1)

    )

  ;;(elpaca-wait)

#+end_src

*** [[http://jblevins.org/projects/markdown-mode/][Markdown Mode]]

Major mode for editing [[http://daringfireball.net/projects/markdown/][Markdown]] formatted text.

#+begin_src emacs-lisp :name markdown
  (use-package markdown-mode
    :defer t
    :after (magit forge lsp-mode)
    :commands (markdown-mode gfm-mode)
    :hook (markdown-mode . flyspell-mode)
    :mode (("README\\.md\\'" . gfm-mode)
           ("\\.md\\'"       . markdown-mode)
           ("\\.markdown\\'" . markdown-mode))
    :custom
    (markdown-command "/opt/homebrew/bin/multimarkdown")
    (markdown-header-scaling t))
#+end_src

*** [[https://magit.vc/][Magit]] & Forge

The absolutely best git porcelain on Planet Earth.

Some more informational links:
https://emacsair.me/2017/09/01/magit-walk-through/
https://emacsair.me/2017/09/01/the-magical-git-interface/
https://www.masteringemacs.org/article/introduction-magit-emacs-mode-git

#+begin_src emacs-lisp :name magit
  (use-package magit
    :hook ((git-commit-setup-hook . git-commit-turn-on-flyspell)
           (git-commit-setup-hook . git-commit-save-message)
           (git-commit-setup-hook . turn-on-auto-fill))
    :init
    (if IS-MAC
        (setq magit-git-executable "/opt/homebrew/bin/git")
      (setq magit-git-executable "/usr/local/bin/git"))
    :config
    ;; Add git-timemachine to the magit-dispatch transient map.
    (transient-append-suffix 'magit-dispatch '(0 -1 -1) '("S" "git timemachine" git-timemachine))

    (setq  magit-log-arguments '("--graph" "--decorate" "--color")
           magit-revert-buffers 'silent
           magit-revision-show-gravatars '("^Author:     " . "^Commit:     ")
           magit-diff-refine-hunk t ; show granular diffs in selected hunk
           ;; Don't autosave repo buffers. This is too magical, and saving can
           ;; trigger a bunch of unwanted side-effects, like save hooks and
           ;; formatters. Trust us to know what we're doing.
           magit-save-repository-buffers nil)

    ;; Open magit-status in entire window & restore the previous window config on close.
    (setq magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1
          magit-bury-buffer-function 'magit-restore-window-configuration))

  (use-package forge
    :after magit)
#+end_src

TODO: Another codereview from magit tool https://github.com/blahgeek/emacs-pr-review for doing reviews with GitHub
TODO: fixes code-review: https://github.com/wandersoncferreira/code-review/pull/246#issuecomment-1867538123

**** [[https://github.com/dandavison/magit-delta][magit-delta]]

Use delta when displaying diffs.

#+begin_src emacs-lisp :name magit-delta
  (use-package magit-delta
    :after magit
    :hook (magit-mode . magit-delta-mode))
#+end_src

**** [[https://github.com/alphapapa/magit-todos][magit-todos]]

Show TODOs in Magit status buffer for each source file.

#+begin_src emacs-lisp :name magit-todos
  (use-package magit-todos
    :after magit
    :config
    (magit-todos-mode +1))
#+end_src
** Appearance
*** Fonts

A million ways to set fonts in Emacs - we will deal with mixed & variable pitch later.
http://idiocy.org/emacs-fonts-and-fontsets.html
https://archive.casouri.cc/note/2021/fontset/index.html

2023-01-21 - This didn't work when it was in early-init.el

#+begin_src emacs-lisp :name Fonts
  (set-face-attribute 'default nil :font "Menlo" :height 120)
  ;;(set-face-attribute 'default nil :font "Victor Mono" :height 110)
  (set-fontset-font t nil "Menlo" nil 'append) ; fallback font
#+end_src

*** [[https://github.com/domtronn/all-the-icons.el][all-the-icons]]

Make the icons in Emacs pretty. Don't forget to run =M-x all-the-icons-install-fonts= if this is a new install.

#+begin_src emacs-lisp :name all_the_icons
  (use-package all-the-icons)
#+end_src
**** [[https://github.com/jtbm37/all-the-icons-dired][all-the-icons-dired]]

Add some =all-the-icons= to dired.

#+begin_src emacs-lisp :name all-the-icons-dired
  (use-package all-the-icons-dired
    :config
    :hook (dired-mode . (lambda ()
                          (interactive)
                          (unless (file-remote-p default-directory)
                            (all-the-icons-dired-mode)))))
#+end_src


*** nerd-icons

#+begin_src emacs-lisp :name nerd-icons
  (use-package nerd-icons
    :ensure t)
#+end_src

*** [[https://github.com/Malabarba/beacon][beacon]]

Try not to lose the cursor on moving.

#+begin_src emacs-lisp :name beacon
  (use-package beacon
    :custom
    (beacon-lighter "")
    (beacon-size 45)
    :config
    (beacon-mode 1))
#+end_src

*** [[https://github.com/Fanael/highlight-numbers][highlight-numbers]]

Highlight numbers in the buffer.

#+begin_src emacs-lisp :name highlight-numbers
  (use-package highlight-numbers
    :hook (prog-mode . highlight-numbers-mode)
    :config
    ;; setting to magenta-warmer for ef-spring theme.
    (set-face-attribute 'highlight-numbers-number nil :foreground "#cb26a0"))
#+end_src

*** [[https://github.com/tarsius/hl-todo][hl-todo]]

Highlight TODO and similar keywords in comments and strings.

By default it is only active in modes that derive from prog-mode.

Integrations:
- =magit-hl-todos=
- =consult-todos=

This package also provides commands for moving to the next or previous keyword,
to invoke occur with a regexp that matches all known keywords, and to insert a keyword.
If you want to use these commands, then you should bind them in hl-todo-mode-map, e.g.:

(define-key hl-todo-mode-map (kbd "C-c p") 'hl-todo-previous)
(define-key hl-todo-mode-map (kbd "C-c n") 'hl-todo-next)
(define-key hl-todo-mode-map (kbd "C-c o") 'hl-todo-occur)
(define-key hl-todo-mode-map (kbd "C-c i") 'hl-todo-insert)

#+begin_src emacs-lisp :name hl-todo
  (use-package hl-todo
    :ensure (hl-todo :depth nil) ; see https://github.com/alphapapa/magit-todos/issues/171
    :init
    (setq hl-todo-highlight-punctuation ":"
          hl-todo-keyword-faces '(("TODO" . "#FF0000")
                                  ("FIXME" . "#FF9999")
                                  ("FAIL" . "#FF0000")
                                  ("DEPRECATED" . "#1F39EF")
                                  ("HACK" . "#FF0000")
                                  ("XXX" . "#FF0000")
                                  ("NOTE" . "#1E90FF")))
    :hook (prog-mode . hl-todo-mode))
#+end_src

*** [[https://github.com/hlissner/emacs-solaire-mode][solaire-mode]]

Help visually distinguish buffers. If you don't like the lighter/darker arrangement you can change it with =(add-to-list 'solaire-mode-themes-to-face-swap 'doom-vibrant)=

Supported themes:
- Doom themes
- nano-theme
- modus-themes
- parchment
- spacemacs-theme
- vscode-dark-plus-theme
- wilmersdorf-theme

#+begin_src emacs-lisp :name solaire-mode
  (use-package solaire-mode
    :config
    (solaire-global-mode +1))
#+end_src

*** [[https://github.com/doomemacs/themes][Doom themes]]

#+begin_src emacs-lisp :name doom-themes
  (use-package doom-themes
    :ensure t
    :config
    (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
          doom-themes-enable-italic t) ; if nil, italics is universally disabled
    (load-theme 'doom-vibrant t)

    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)

    ;; or for treemacs users
    (setq doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
    (doom-themes-treemacs-config)

    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config)
    )
  (face-spec-set 'tree-sitter-hl-face:method\.call '((t (:inherit tree-sitter-hl-face:function\.call :foreground "red"))))
#+end_src

*** Doom modeline

#+begin_src emacs-lisp :name doom-modeline
    (use-package doom-modeline
      :custom
      (doom-modeline-buffer-file-name-style 'truncate-upto-root)
      (doom-modeline-buffer-name t)
      (doom-modeline-vcs-max-length 35)
      (doom-modeline-icon t)
      (doom-modeline-display-default-persp-name t)
      :init
      (doom-modeline-mode 1)
      :config
      (setq inhibit-compacting-font-caches t) ;; Don´t compact font caches during GC

      ;; This in combination w/ reducing the height allows everything to fit on the modeline.
      (setq nerd-icons-scale-factor 1.1)

      (unless (eq system-type 'darwin)
        (if (facep 'mode-line-active)
            (set-face-attribute 'mode-line-active nil
                                :family "Hack"
                                :height 100) ; For 29+
          (set-face-attribute 'mode-line nil
                              :family "Hack"
                              :height 100))
        (set-face-attribute 'mode-line-inactive nil
                            :family "Hack"
                            :height 100))

      (when (eq system-type 'darwin)
        (if (facep 'mode-line-active)
            (set-face-attribute 'mode-line-active nil
                                :family "Hack Nerd Font"
                                :height 110) ; For 29+
          (set-face-attribute 'mode-line nil
                              :family "Hack Nerd Font"
                              :height 110))
        (set-face-attribute 'mode-line-inactive nil
                            :family "Hack Nerd Font"
                            :height 110)))
#+end_src

*** [[https://github.com/hlissner/emacs-hide-mode-line][hide-modeline-mode]]

Hide the modeline for certain buffers, e.g. shells, terminals

#+begin_src emacs-lisp :name hide-modeline-mode
  (use-package hide-mode-line
    :ensure (:host github :repo "hlissner/emacs-hide-mode-line" :main "hide-mode-line.el")
    :hook (((completion-list-mode
             eshell-mode shell-mode
             term-mode vterm-mode
             lsp-ui-menu-mode
             pdf-annot-list-mode) . hide-mode-line-mode))
    :config
    (hide-mode-line-mode))
#+end_src

*** [[https://github.com/Fanael/rainbow-delimiters][rainbow-delimiters]]

Make parenthesis' standout no matter your language.

#+begin_src emacs-lisp :name rainbow-delimiters
  (use-package rainbow-delimiters
    :config
    (add-hook 'prog-mode-hook #'rainbow-delimiters-mode))
#+end_src

** Completion Frameworks

*** [[https://github.com/abo-abo/avy][avy]]

Jump to things in Emacs tree-style

#+begin_src emacs-lisp :name avy
  (use-package avy
    :defer t
    :config
    (setq avy-all-windows nil
          avy-background t))
#+end_src

*** [[https://github.com/minad/vertico][vertico]] & [[https://github.com/tumashu/vertico-posframe][vertico-posframe]]

Vertico provides a performant and minimalistic vertical completion UI based on the default completion system.

#+begin_src emacs-lisp :name vertico
  ;; https://github.com/daut/dotfiles/blob/2ad4f5a5e0f1e786c91f17460d8599ec5d57318b/.emacs.d/init.el#L105
  (defun daut/minibuffer-backward-kill (arg)
    (interactive "p")
    (if (and minibuffer-completing-file-name
	     (eq (char-before) ?/))
	(zap-up-to-char (- arg) ?/)
      (delete-backward-char arg)))

  (use-package vertico
    :ensure t
    :general
    (:keymaps 'vertico-map
	      "<backspace>" #'daut/minibuffer-backward-kill
	      "<escape>" #'minibuffer-keyboard-quit
	      "C-w" #'backward-kill-word)
    :custom
    (vertico-cycle t)
    (vertico-count 45)
    (vertico-resize t)  ; allow vertico size to shrink and grow based on vertico count
    :init
    (vertico-mode t))

  (use-package vertico-posframe
    :ensure t
    :init (vertico-posframe-mode)
    :config
    (setq vertico-multiform-commands
	  '((consult-line (:not posframe))
	    (consult-ripgrep (:not posframe))
	    (t posframe)))
    (vertico-multiform-mode t))
#+end_src

*** marginalia

#+begin_src emacs-lisp :name marginalia
  (use-package marginalia
    :ensure t
    :general
    (:keymaps 'minibuffer-local-map
              "s-a" 'marginalia-cycle)
    :custom
    (marginalia-max-relative-age 0)
    (marginalia-align 'left)
    :init
    (marginalia-mode 1))
#+end_src

*** orderless

#+begin_src emacs-lisp :name orderless
  (use-package orderless
    :ensure t
    :custom
    (completion-category-defaults nil)
    (completion-styles '(orderless basic))
    (completion-category-overrides '((file (styles basic-remote ; For 'tramp' hostname completion
						   partial-completion)))))
#+end_src

*** consult

#+begin_src emacs-lisp :name consult
  (use-package consult
    :ensure t
    :bind (("C-c r" . consult-ripgrep)
           ("s-i" . consult-buffer)
           ("s-r" . consult-ripgrep)
           ;; Misc bindings
           ("s-y" . consult-yank-pop))

    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    :config
    ;; Preview
    ;; (setq consult-preview-key "s-.")

    ;; Narrowing
    (setq consult-narrow-key "<") ; Prefix key for narrowing results
    (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help) ; get help for narrowing

    ;; Using project.el for project support.
    ;; (setq consult-project-function #'consult--default-project--function))
    )
#+end_src

**** [[https://github.com/minad/consult-flycheck][consult-flycheck]] & [[https://www.flycheck.org/en/latest/user/quickstart.html][flycheck]]

Integrates consult and flycheck.

#+begin_src emacs-lisp :name flycheck
  (use-package flycheck
    :hook (prog-mode . global-flycheck-mode)
    :general
    (:keymaps 'flycheck-mode-map
              "M-n" 'flycheck-next-error
              "M-p" 'flycheck-previous-error))
#+end_src

#+begin_src emacs-lisp :name consult-flycheck
  (use-package consult-flycheck
    :after flycheck)
#+end_src

**** [[https://github.com/armindarvish/consult-gh][consult-gh]]

11/30/24 18:38:00
This was adding 18-20sec. to startup time?!? Disabling for now - also couldn't get it to display PRs either in Emacs or in a browser.  Strangely, the preview worked just fine.

  ;; (use-package consult-gh
  ;;   :ensure (consult-gh :type git :host github :repo "armindarvish/consult-gh")
  ;;   :after consult
  ;;   :custom
  ;;   (consult-gh--default-maxnum 50)                                  ;; change defualt max number of repos to 50
  ;;   (consult-gh-show-preview t)                                      ;; show preview automatically
  ;;   (consult-gh-preview-buffer-mode 'org-mode)                       ;; convert markdown files to org-mode for previews
  ;;   (consult-gh-issue-action #'consult-gh--issue-view-action)        ;; view issues inside emacs
  ;;   (consult-gh-repo-action #'consult-gh--repo-browse-files-action)  ;; browse files inside emacs
  ;;   (consult-gh-file-action #'consult-gh--files-view-action)         ;; open files in an emacs buffer
  ;;   :config
  ;;   (add-to-list 'consult-gh-default-orgs-list "eig") ;;add your GitHub user
  ;;   (require 'consult-gh-embark)
  ;;   (add-to-list 'savehist-additional-variables 'consult-gh--known-orgs-list)   ;; keep record of searched orgs
  ;;   (add-to-list 'savehist-additional-variables 'consult-gh--known-repos-list)) ;; keep record of searched repos


  (use-package consult-gh
    :after consult
    :custom
    (consult-gh-default-clone-directory "~/WorkStuff/eig/")
    (consult-gh-show-preview t)
    (consult-gh-preview-key "C-o")
    (consult-gh-repo-action #'consult-gh--repo-browse-files-action)
    (consult-gh-issue-action #'consult-gh--issue-view-action)
    (consult-gh-pr-action #'consult-gh--pr-view-action)
    (consult-gh-code-action #'consult-gh--code-view-action)
    (consult-gh-file-action #'consult-gh--files-view-action)
    (consult-gh-notifications-action #'consult-gh--notifications-action)
    (consult-gh-dashboard-action #'consult-gh--dashboard-action)
    (consult-gh-large-file-warning-threshold 2500000)
    (consult-gh-prioritize-local-folder 'suggest)
    :config
    (setq consult-gh-default-orgs-list (consult-gh--get-current-orgs t))
    ;; (add-to-list 'consult-gh-default-orgs-list "eig")

    ;; Add a hook to change default organizations when the account is switched
    (add-hook 'consult-gh-auth-post-switch-hook (lambda (&rest args)
                                                  (setq consult-gh-default-orgs-list (consult-gh--get-current-orgs t))))

  ;; Remember visited orgs and repos across sessions
  (add-to-list 'savehist-additional-variables 'consult-gh--known-orgs-list)
  (add-to-list 'savehist-additional-variables 'consult-gh--known-repos-list))


  ;; Install `consult-gh-embark' for embark actions
  (use-package consult-gh-embark
    :config
    (consult-gh-embark-mode +1))


  ;; Install `consult-gh-forge' for forge actions
  (use-package consult-gh-forge
   :config
   (consult-gh-forge-mode +1)
   (setq consult-gh-forge-timeout-seconds 20))

**** [[https://github.com/ghosty141/consult-git-log-grep][consult-git-log-grep]]

#+begin_src emacs-lisp :name consult-git-log-grep
  (use-package consult-git-log-grep
    :ensure t
    :custom
    (consult-git-log-grep-open-function #'magit-show-commit))
#+end_src

**** [[https://github.com/Ladicle/consult-tramp][consult-tramp]]

Use consult to select tramp targets.  Also supports ssh config, known hosts and docker containers.

#+begin_src emacs-lisp :name consult-tramp
  (use-package consult-tramp
    :ensure (consult-tramp :type git :host github :repo "Ladicle/consult-tramp")
    :config
    (setq consult-tramp-extra-targets '("/ssh:cxo-vdt8-567.cxo.storage.hpecorp.net:/data/workspace/")))
#+end_src

**** consult-omni

#+begin_src emacs-lisp :name consult-omni
  ;; https://github.com/agzam/browser-hist.el
  (use-package browser-hist
    :init
    ;; (require 'embark) ; load Embark before the command (if you're using it)
    :config
    (setq browser-hist-default-browser 'chrome)
    :commands (browser-hist-search))

  (elpaca-wait)

  (use-package consult-omni
    :ensure (consult-omni :type git :host github :repo "armindarvish/consult-omni" :branch "main" :files (:defaults "sources/*.el"))
    :after consult
    :custom

    ;;; General settings that apply to all sources

    (consult-omni-show-preview t) ;;; show previews
    (consult-omni-preview-key "C-o") ;;; set the preview key to C-o
    (consult-omni-highlight-matches-in-minibuffer t) ;;; highlight matches in minibuffer
    (consult-omni-highlight-matches-in-file t) ;;; highlight matches in files
    (consult-omni-default-count 5) ;;; set default count
    (consult-omni-default-page 0) ;;; set the default page (default is 0 for the first page)

    ;; optionally change the consult-omni debounce, throttle and delay.
    ;; Adjust these (e.g. increase to avoid hiting a source (e.g. an API) too frequently)
    (consult-omni-dynamic-input-debounce 0.8)
    (consult-omni-dynamic-input-throttle 1.6)
    (consult-omni-dynamic-refresh-delay 0.8)

    ;; Optionally set backend for http request (either 'url, 'request, or 'plz)
    (consult-omni-http-retrieve-backend 'plz)
    (setq consult-omni-log-level 'debug)


    :config

    ;;; Load Sources Core code
    (require 'consult-omni-sources)

    ;;; Load Embark Actions
    (require 'consult-omni-embark)

    ;;; Either load all source modules or a selected list
    ;; Select a list of modules you want to aload, otherwise all sources all laoded
    ; (setq consult-omni-sources-modules-to-load (list 'consult-omni-wkipedia 'consult-omni-notes))
    (consult-omni-sources-load-modules)

    ;; set multiple sources for consult-omni-multi command. Change these lists as needed for different interactive commands. Keep in mind that each source has to be a key in `consult-omni-sources-alist'.
    (setq consult-omni-multi-sources '("calc"
                                       ;; "File"
                                       ;; "Buffer"
                                       ;; "Bookmark"
                                       "Apps"
                                       ;; "gptel"
                                       "Brave"
                                       "Dictionary"
                                       ;; "Google"
                                       "Wikipedia"
                                       "elfeed"
                                       ;; "mu4e"
                                       ;; "buffers text search"
                                       "Notes Search"
                                       "Org Agenda"
                                       "GitHub"
                                       ;; "YouTube"
                                       "Invidious"))

    ;;; Per source customization

    ;; Set API KEYs. It is recommended to use a function that returns the string for better security.
    (setq consult-omni-google-customsearch-key "YOUR-GOOGLE-API-KEY-OR-FUNCTION")
    (setq consult-omni-google-customsearch-cx "YOUR-GOOGLE-CX-NUMBER-OR-FUNCTION")
    (setq consult-omni-brave-api-key "YOUR-BRAVE-API-KEY-OR-FUNCTION")
    (setq consult-omni-stackexchange-api-key "YOUR-STACKEXCHANGE-API-KEY-OR-FUNCTION")
    (setq consult-omni-pubmed-api-key "YOUR-PUBMED-API-KEY-OR-FUNCTION")
    (setq consult-omni-openai-api-key "YOUR-OPENAI-API-KEY-OR-FUNCTION")
    ;; add more keys as needed here.

    ;; gptel settings
    (setq consult-omni-gptel-cand-title #'consult-omni--gptel-make-title-short-answer)

    ;; default terminal
    (setq consult-omni-embark-default-term #'vterm)

    ;; default video player
    (setq consult-omni-embark-video-default-player  #'mpv-play-url)

    ;; pretty prompt for launcher
    (setq consult-omni-open-with-prompt "  ")

    ;;; Pick you favorite autosuggest command.
    (setq consult-omni-default-autosuggest-command #'consult-omni-dynamic-brave-autosuggest) ;;or any other autosuggest source you define

    ;;; Set your shorthand favorite interactive command
    (setq consult-omni-default-interactive-command #'consult-omni-multi)

    ;;; Optionally Set back-end for notes search to ripgrep-all (requires ripgrep-all)
    ;; (setq consult-omni-notes-backend-command "rga")

    ;;; Optionally add more interactive commands

    ;; consult-omni-web
    (defvar consult-omni-web-sources (list "gptel"
                                           "Brave"
                                           "elfeed"
                                           "mu4e"
                                           "Wikipedia"
                                           "GitHub"
                                           "Invidious"
                                           ))
    (defun consult-omni-web (&optional initial prompt sources no-callback &rest args)
      "Interactive web search”

  This is similar to `consult-omni-multi', but runs the search on
  web sources defined in `consult-omni-web-sources'.
  See `consult-omni-multi' for more details.
  "
      (interactive "P")
      (let ((prompt (or prompt (concat "[" (propertize "consult-omni-web" 'face 'consult-omni-prompt-face) "]" " Search:  ")))
            (sources (or sources consult-omni-web-sources)))
        (consult-omni-multi initial prompt sources no-callback args)))

    ;; consult-omni-local
    (defvar consult-omni-local-sources (list "ripgrep"
                                             "mdfind"
                                             "Notes Search"
                                             "Apps"
                                             "Org Agenda"))
    (defun consult-omni-local (&optional initial prompt sources no-callback &rest args)
      "Interactive local search”

  This is similar to `consult-omni-multi', but runs the search on
  local sources defined in `consult-omni-local-sources'.
  See `consult-omni-multi' for more details.
  "
      (interactive "P")
      (let ((prompt (or prompt (concat "[" (propertize "consult-omni-local" 'face 'consult-omni-prompt-face) "]" " Search:  ")))
            (sources (or sources consult-omni-local-sources)))
        (consult-omni-multi initial prompt sources no-callback args)))

    ;; consult-omni-scholar
    (setq consult-omni-scholar-sources (list "PubMed" "Scopus" "Notes Search" "gptel"))

    (defun consult-omni-scholar (&optional initial prompt sources no-callback &rest args)
      "Interactive “multi-source acadmic literature” search

  This is similar to `consult-omni-multi', but runs the search on
  academic literature sources defined in `consult-omni-scholar-sources'.
  See `consult-omni-multi' for more details.
  "
      (interactive "P")
      (let ((prompt (or prompt (concat "[" (propertize "consult-omni-multi" 'face 'consult-omni-prompt-face) "]" " Search:  ")))
            (sources (or sources consult-omni-scholar-sources)))
        (consult-omni-multi initial prompt sources no-callback args)))

    ;; AutoSuggest at point
    (defun consult-omni-autosuggest-at-point ()
    (interactive)
    (let ((input (or (thing-at-point 'url) (thing-at-point 'filename) (thing-at-point 'symbol) (thing-at-point 'sexp) (thing-at-point 'word))))
      (when (and (minibuffer-window-active-p (selected-window))
                 (equal (substring input 0 1) (consult--async-split-initial nil)))
        (setq input (substring input 1)))
      (consult-omni-brave-autosuggest input))))
#+end_src

**** [[https://github.com/mohkale/consult-yasnippet][consult-yasnippet]]

A consult interface for yasnippet.

#+begin_src emacs-lisp :name consult-yasnippet
  (use-package consult-yasnippet
    :after yasnippet)
#+end_src

*** embark

#+begin_src emacs-lisp :name embark
  (use-package embark
    :ensure t
    :bind (("C-." . embark-act)
           :map minibuffer-local-map
           ("C-c C-c" . embark-collect)
           ("C-c C-e" . embark-export)))
#+end_src

*** embark-consult

#+begin_src emacs-lisp :name embark-consult
  (use-package embark-consult
    :ensure t
    :after (embark consult)
    :demand t
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

*** [[https://github.com/iyefrat/all-the-icons-completion][all-the-icons-completion]]

Add icons to completion candidates.

#+begin_src emacs-lisp :name all-the-icons-completion
  (use-package all-the-icons-completion
    :after (marginalia all-the-icons)
    :hook (marginalia-mode . all-the-icons-completion-marginalia-setup)
    :init
    (all-the-icons-completion-mode))
#+end_src

*** [[https://github.com/jdtsmith/kind-icon][kind-icon]]

Add some icons to completion prefixes.

#+begin_src emacs-lisp :name kind-icon
  (use-package kind-icon
    :after corfu
    :custom
    (kind-icon-use-icons t)
    ;; No pollution. Change the location of the svg-lib cache directory.
    (svg-lib-icons-dir (no-littering-expand-var-file-name "svg-lib/cache"))
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src

*** company

Company works better with lsp-mode

#+begin_src emacs-lisp :name company
  (use-package company
    :ensure t
    :config
    (global-company-mode 1))
#+end_src

** Emacs Defaults

#+begin_src emacs-lisp :name defaults
  (setq-default
   tab-always-indent 'complete                      ; Indent, if already indented, try to complete
   display-time-default-load-average nil            ; Don't display load average
   fill-column 100                                  ; Set column width
   help-window-select t                             ; Focus new help windows when opened
   indent-tabs-mode nil                             ; Prefer spaces over tabs, duh.
   tab-width 4                                      ; Set width for tabs
   kill-ring-max 128                                ; Maximum length of kill ring
   load-prefer-newer t                              ; Prefer the newest version of a file
   mark-ring-max 128                                ; Maximum length of mark ring
   select-enable-clipboard t                        ; Merge system's and Emacs' clipboard
   x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)
   user-full-name "ERick BOdine"                    ; Name
   vc-follow-symlinks t                             ; Always follow the symlinks
   frame-title-format '("Emacs: %f")                ; Frame title
   icon-title-format frame-title-format             ; OS icon title
   message-log-max 8192                             ; Don't lose any logging information.
   bidi-paragraph-separate-re "^"
   bidi-paragraph-start-re "^"
   ring-bell-function 'ignore                       ; Turn off the damn bell!
   history-delete-duplicates t                      ; Remove dups from helm-M-x & such.
   history-length 55                                ; Limit history length; see above.
   view-read-only t)                                ; Always open read-only buffers in view-mode

  ;; sane trackpad/mouse scroll settings
  (when IS-MAC
    (setq mac-redisplay-dont-reset-vscroll t
          mac-mouse-wheel-smooth-scroll nil))

  ;; Some IO related settings.
  ;; support reading large blobs of data
  (setq process-adaptive-read-buffering nil
        read-process-output-max (* 2048 2048))

  ;; Reduce rendering/line scan work for Emacs by not rendering cursors or regions
  ;; in non-focused windows.
  (setq-default cursor-in-non-selected-windows nil)
  (setq highlight-nonselected-windows nil)

  ;; More performant rapid scrolling over unfontified regions. May cause brief
  ;; spells of inaccurate syntax highlighting right after scrolling, which should
  ;; quickly self-correct.
  (setq fast-but-imprecise-scrolling t)

  ;;; Scrolling
  ;;; These are mostly Doom Emacs changes.
  (setq hscroll-margin 2
        hscroll-step 1
        scroll-conservatively 10
        scroll-margin 0
        scroll-preserve-screen-position t
        auto-window-vscroll nil)

  ;; Resizing the Emacs frame can be a terribly expensive part of changing the
  ;; font. By inhibiting this, we halve startup times, particularly when we use
  ;; fonts that are larger than the system default (which would resize the frame).
  (setq frame-inhibit-implied-resize t)

  ;; Don't popup UI/graphical dialog boxes.
  (setq use-dialog-box nil)


  ;; Don't ping things that look like domain names.
  (setq ffap-machine-p-known 'reject)

  ;; Font compacting can be terribly expensive, especially for rendering icon
  ;; fonts on Windows. Whether it has a noteable affect on Linux and Mac hasn't
  ;; been determined, but we inhibit it there anyway.
  (setq inhibit-compacting-font-caches t)

  ;; Remove command line options that aren't relevant to our current OS; means
  ;; slightly less to process at startup.
  (unless IS-MAC   (setq command-line-ns-option-alist nil))
  (unless IS-LINUX (setq command-line-x-option-alist nil))

  ;; Make apropos more useful
  (setq apropos-do-all t)

  ;; Silence advised functions warnings
  (setq ad-redefinition-action 'accept)

  ;; Don't pass over `auto-mode-alist' a second time.
  (setq auto-mode-case-fold nil)

  ;; don't ask to kill buffers
  (setq kill-buffer-query-functions
        (remq 'process-kill-buffer-query-function
              kill-buffer-query-functions))

  ;; Get rid of "For information about GNU Emacs..." message at startup
  (unless noninteractive
    (advice-add #'display-startup-echo-area-message :override #'ignore)
    (setq inhibit-startup-message t
          inhibit-startup-echo-area-message user-login-name
          inhibit-default-init t
          ;; initial-major-mode 'fundamental-mode
          initial-scratch-message ";; Welcome to the Church of Emacs, Cardinal deftpunk presiding"
          mode-line-format nil))
  ;; we're in a daemon session, where it'll say "Starting Emacs daemon." instead
  (unless (daemonp)
    (advice-add #'display-startup-echo-area-message :override #'ignore))

  ;; This file stores usernames, passwords, and such.
  (setq auth-sources (list (expand-file-name "authinfo.gpg" deftpunk--etc-dir) "~/.authinfo.gpg"))

  ;; Some timezone stuff for logview.el and others.
  (setenv "TZ" "America/Denver")
  (setq datetime-timezone "America/Denver")

  ;; I actually find the custom system a nuisance; move the file out of the way.
  (setq custom-file (expand-file-name "custom.el" deftpunk--var-dir))
  (load custom-file :no-error-if-file-is-missing)


  ;; Replace yes/no prompts with y/n
  (fset 'yes-or-no-p 'y-or-n-p)

  ;; see https://www.emacswiki.org/emacs/BrowseUrl#h5o-7
  (after! browse-url
    (setq browse-url-browser-function 'browse-url-chrome
          browse-url-chrome-program "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
          browse-url-new-window-flag  t))

  ;; Don't ask if you want to kill a buffer with a live process attached to it:
  (remove-hook 'kill-buffer-query-functions 'process-kill-buffer-query-function)

  (after! simple
          ;; The following may be of interest to people who (a) are happy with
          ;; "C-w" and friends for killing and yanking, (b) use
          ;; "transient-mark-mode", (c) also like the traditional Unix tty
          ;; behaviour that "C-w" deletes a word backwards. It tweaks "C-w" so
          ;; that, if the mark is inactive, it deletes a word backwards instead
          ;; of killing the region. Without that tweak, the C-w would create an
          ;; error text without an active region.
          ;; http://www.emacswiki.org/emacs/DefaultKillingAndYanking#toc2

          (defadvice kill-region (before unix-werase activate compile)
            "When called interactively with no active region, delete a single word backwards
             instead."
            (interactive
             (if mark-active (list (region-beginning) (region-end))
               (list (save-excursion (backward-word 1) (point)) (point))))))

  ;; Deleting past a tab normally changes tab into spaces. Don't do
  ;; that, kill the tab instead.
  (setq backward-delete-char-untabify-method nil)

  ;; Don't type C-u C-SPC C-u C-SPC to pop 2 marks, now you can do C-u C-SPC C-SPC
  (setq set-mark-command-repeat-pop t)

  ;; Revert buffers when the underlying file has changed.
  (global-auto-revert-mode 1)
  ;; Revert Dired and other buffers
  (setq global-auto-revert-non-file-buffers t)

  ;; no lockfiles
  (setq create-lockfiles nil)
#+end_src

** Emacs builtin modes

*** [[https://www.emacswiki.org/emacs/AbbrevMode][abbreviations]]

The abbreviations file is saved by =no-littering= into our =etc/= directory as =abbrev.el=

#+begin_src emacs-lisp :name abbreviations
  (setq-default save-abbrevs 'silently)

  ;; Turn abbreviations on globally.
  (setq-default abbrev-mode t)
  (blackout 'abbrev-mode)

  ;; Read the abbrev file on startup.
  (quietly-read-abbrev-file)
#+end_src

**** Some function based abbreviations

#+begin_src emacs-lisp :name function-abbreviations
  (defun deftpunk/current-time ()
    (interactive)
    (insert (format-time-string "%D %T")))
  (define-abbrev global-abbrev-table "ydate" "" 'deftpunk/current-time)
#+end_src

*** ansi-color

#+begin_src emacs-lisp :name ansi-color
  (use-package ansi-color
    :ensure nil)
#+end_src

*** auto-revert

#+begin_src emacs-lisp :name auto-revert
  ;; Revert Dired and other buffers
  (setq global-auto-revert-non-file-buffers t)
  ;; Revert buffers when the underlying file has changed.
  (global-auto-revert-mode 1)
#+end_src

*** auto-save & backups

Saving and backing up files. While its nice to assume that everything is in source control this is a handy fallback.

#+begin_src emacs-lisp :name auto-save-backup
  ;; https://www.emacswiki.org/emacs/BackupDirectory
  ;; https://stackoverflow.com/questions/151945/how-do-i-control-how-emacs-makes-backup-files

  ;; Default and per-save backups go here:
  (setq backup-directory-alist `(("" . ,(expand-file-name "backups" deftpunk--var-dir))))

  (defun force-backup-of-buffer ()
    ;; Make a special "per session" backup at the first save of each
    ;; emacs session.
    (when (not buffer-backed-up)
      ;; Override the default parameters for per-session backups.
      (let ((backup-directory-alist '(("" . "~/.emacs.d/backup/per-session")))
            (kept-new-versions 3))
        (backup-buffer)))
    ;; Make a "per save" backup on each save.  The first save results in
    ;; both a per-session and a per-save backup, to keep the numbering
    ;; of per-save backups consistent.
    (let ((buffer-backed-up nil))
      (backup-buffer)))

  (add-hook 'before-save-hook  'force-backup-of-buffer)

  (setq version-control t              ; Use version numbers for backup
        kept-new-versions 5            ; Number of newest version to keep around
        kept-old-versions 0            ; Number of oldest versions to keep around
        delete-old-versions t          ; Don't ask to delete older versions
        backup-by-copying t            ; Copy all files, don't rename them - best compromise for safety.
        vc-make-backup-files t         ; Even backup files under version control
        )
#+end_src

*** [[https://www.gnu.org/software/emacs/manual/html_node/efaq/Displaying-the-current-line-or-column.html][column-number-mode]]

#+begin_src emacs-lisp :name column-number-mode
  (column-number-mode 1)
#+end_src

*** compile

#+begin_src emacs-lisp :name compile
  (after! compile
    (setq compilation-always-kill t       ; kill compilation process before starting another.
          compilation-ask-about-save nil  ; save all buffers.
          compilation-auto-jump-to-first-error t
          compilation-scroll-output 'first-error)

    ;; Take care of color codes in the output and colorize the compilation buffer.
    (add-hook 'compilation-filter-hook 'ansi-color-compilation-filter)

    (autoload 'comint-truncate-buffer "comint" nil t)
    (add-hook 'compilation-filter-hook #'comint-truncate-buffer)
    )

  (setopt compilation-ask-about-save nil)

  (deftpunk-local-leader-def
    :keymaps 'compilation-mode-map
    "o" '(ace-link :which-keys "Highlight links in compilation buffer"))
#+end_src

*** Dired

#+begin_src emacs-lisp :name dired
  (use-package dired
    :ensure nil
    :general
    (:keymaps 'dired-mode-map
              "RET" #'dired-find-alternate-file
              "^" (lambda ()
                    (interactive)
                    (find-alternate-file "..")))
    :custom
    ;; Allow dired to delete or copy a dir.
    ;; 02/14/24 17:41:48 - These default to 'top in dired now.
    ;; 'top means ask every time.
    ;; 'always means don't ask.
    (dired-recursive-copies 'top)
    (dired-recursive-deletes 'top)
    :config

    ;; Open marked files in dired
    ;; http://xahlee.info/emacs/emacs/emacs_dired_open_marked.html
    (defun xah-dired-open-marked ()
      "Open marked files in `dired'.
  URL `http://xahlee.info/emacs/emacs/emacs_dired_open_marked.html'
  Version 2019-10-22"
      (interactive)
      (mapc 'find-file (dired-get-marked-files)))

    ;; Make dired open in the same window when using RET or ^
    ;; Make Dired only use a single buffer when visiting a directory.
    ;; http://ergoemacs.org/emacs/emacs_dired_tips.html
    (put 'dired-find-alternate-file 'disabled nil) ; disables warning
    (define-key dired-mode-map (kbd "RET") 'dired-find-alternate-file) ; was dired-advertised-find-file
    (define-key dired-mode-map (kbd "^") (lambda ()
                                           (interactive)
                                           (find-alternate-file ".."))))  ; was dired-up-directory
#+end_src

**** dired-plus

#+begin_src emacs-lisp :name dired-plus
  (use-package dired+
    :ensure (dired+ :type git :host github :repo "emacsmirror/dired-plus"))
#+end_src

**** [[https://github.com/Fuco1/dired-hacks/blob/master/dired-subtree.el][dired-subtree]]

view/toggle subtrees(dirs) in dired.

#+begin_src emacs-lisp :name dired-subtree
  ;; 12/02/24 23:05:16 changed from :general to :bind in order to avoid "dired-subtree/:catch: Wrong
  ;; type argument: listp, dired-subtree-toggle" error... ??
  (use-package dired-subtree
    :ensure t
    :after dired
    :bind (:map dired-mode-map
              ("i" . dired-subtree-insert)
              (";" . dired-subtree-remove)
              ("<tab>" . dired-subtree-toggle)
              ("<backtab>" . dired-subtree-cycle)
              ("S-TAB" . dired-subtree-cycle)
              ))
#+end_src

*** [[https://www.gnu.org/software/emacs/manual/html_mono/ediff.html][ediff]]

Visual interface to diff and patch.

#+begin_src emacs-lisp :name ediff
  (use-package ediff
    :ensure nil
    :custom
    (ediff-diff-options "-w")
    (ediff-use-long-help-message t)
    (ediff-split-window-function #'split-window-horizontally)
    (ediff-window-setup-function #'ediff-setup-windows-plain)
    :config

  ;; I just want to restore the previous window layout... so hard.
  ;; Added to and modified from https://emacs.stackexchange.com/questions/7482/restoring-windows-and-layout-after-an-ediff-session
  (defvar my-ediff-last-windows nil
    "Window configuration prior to calling `ediff-buffers',
  `ediff-regions-linewise', or `ediff-regions-wordwise'.")

  (defun my-ediff-restore-last-windows ()
    "Set window configuration to `my-ediff-last-windows'."
    (cond (my-ediff-last-windows
           (set-window-configuration my-ediff-last-windows)
           (setq my-ediff-last-windows nil))))

  (add-hook 'ediff-quit-hook #'my-ediff-restore-last-windows)

  (defadvice ediff-buffers (before ediff-buffers-advice activate)
    (setq my-ediff-last-windows (current-window-configuration)))

  (defadvice ediff-regions-linewise (before ediff-regions-linewise-advice activate)
    (setq my-ediff-last-windows (current-window-configuration)))

  (defadvice ediff-regions-wordwise (before ediff-regions-wordwise-advice activate)
    (setq my-ediff-last-windows (current-window-configuration)))

  ;; For ediff-buffers/ediff-files
  (defvar ediff-last-windows nil
    "Last ediff window configuration.")

  (defun ediff-restore-windows ()
    "Restore window configuration to `ediff-last-windows'."
    (set-window-configuration ediff-last-windows)
    (remove-hook 'ediff-after-quit-hook-internal
                 'ediff-restore-windows))

  (defadvice ediff-buffers (around ediff-restore-windows activate)
    (setq ediff-last-windows (current-window-configuration))
    (add-hook 'ediff-after-quit-hook-internal 'ediff-restore-windows)
    ad-do-it)

  (defadvice ediff-files (around ediff-restore-windows activate)
    (setq ediff-last-windows (current-window-configuration))
    (add-hook 'ediff-after-quit-hook-internal 'ediff-restore-windows)
    ad-do-it)
  )
#+end_src

*** flyspell

#+begin_src emacs-lisp :name flyspell
  ;; Remove the C-; key so that we can use it for a local-leader
  (general-define-key
   :keymaps 'flyspell-mode-map
   "C-;" nil)
#+end_src

*** [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Cursor-Display.html#index-highlight-current-line][hl-line-mode]]

Highlight the current line.

#+begin_src emacs-lisp :name hl-line
  (use-package hl-line
    :ensure nil
    :custom
    (hl-line-sticky-flag nil) ; Don't highlight current line across windows.
    :config
    (defun eat/hl-line-setup ()
      "Disable `hl-line-mode' if region is active."
      (when (and (bound-and-true-p hl-line-mode)
                 (region-active-p))
        (hl-line-unhighlight)))

    (with-eval-after-load 'hl-line
      (add-hook 'post-command-hook #'eat/hl-line-setup))

    (add-hook 'prog-mode-hook #'hl-line-mode)
    (add-hook 'text-mode-hook #'hl-line-mode))
#+end_src

*** [[https://www.emacswiki.org/emacs/RecentFiles][recentf]]

Keep track of recently used files.

#+begin_src emacs-lisp :name recentf
  (use-package emacs
    :ensure nil
    :custom
    (recentf-max-saved-items 250)
    (recentf-max-menu-items 15)
        ;; disable recentf-cleanup on Emacs start, because it can cause
        ;; problems with remote files, ie. Tramp files.
    (recentf-save-file "~/.emacs.d/etc/recentf-save.el")
    (recentf-auto-cleanup 'never)
    (recentf-exclude (list "/scp:"
                           "/ssh:"
                           "/sudo:"
                           "/tmp/"
                           "~$"
                           "COMMIT_EDITMSG"))
    :config
    (recentf-mode +1))
#+end_src

*** [[https://www.emacswiki.org/emacs/SaveHist][savehist]]

Save the minibuffer history.

#+begin_src emacs-lisp :name savehist
  (setq savehist-file (expand-file-name "savehist" deftpunk--var-dir)
        history-length 65                                                ; reducing size helps reduce startup cost.
        history-delete-duplicates t
        savehist-save-minibuffer-history t
        savehist-additional-variables '(kill-ring
                                        search-ring
                                        mark-ring
                                        global-mark-ring
                                        regexp-search-ring
                                        extended-command-history
                                        regexp-search-ring))
  (savehist-mode 1)

  ;; Limit some of the items in savehist
  (put 'savehist-minibuffer-history-variables 'history-length 50)
  (put 'org-read-date-history                 'history-length 50)
  (put 'read-expression-history               'history-length 50)
  (put 'org-table-formula-history             'history-length 50)
  (put 'extended-command-history              'history-length 50)
  (put 'ido-file-history                      'history-length 50)
  (put 'helm-M-x-input-history                'history-length 50)
  (put 'minibuffer-history                    'history-length 50)
  (put 'ido-buffer-history                    'history-length 50)
  (put 'buffer-name-history                   'history-length 50)
  (put 'file-name-history                     'history-length 50)
#+end_src

*** [[https://www.emacswiki.org/emacs/SavePlace][saveplace]]

Remembering the last place you visited in a file.

#+begin_src emacs-lisp :name saveplace
  (use-package saveplace
    :ensure nil
    :custom
    (save-place-limit 100)
    (save-place-file (expand-file-name "emacs-places" deftpunk--var-dir))
    (save-place-forget-unreadable-files nil)  ; Setting to t has the potential to make exiting slow
    :config
    (save-place-mode 1)
    (add-hook 'save-place-find-file-hook 'recenter)
    (add-hook 'find-file-hook 'save-place-find-file-hook t))
#+end_src

*** [[https://www.gnu.org/software/tramp/][Tramp]]

Accessing remote files transparently
https://www.reddit.com/r/emacs/comments/lp8bjb/tramp_keeps_reopening_connections_doom_emacs/

#+begin_src emacs-lisp :name Tramp
  (use-package tramp
    :ensure nil
    :custom
    (tramp-default-method "ssh")
    ;; https://www.reddit.com/r/emacs/comments/lp8bjb/comment/goai6ig/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button
    (tramp-ssh-controlmaster-options (concat
                                      "-o ControlPath=\~/.ssh/cons/ssh-%%r@%%h:%%p "
                                      "-o ControlMaster=auto -o ControlPersist=yes"))
    :config
    (setq remote-file-name-inhibit-cache nil)
    (setq vc-ignore-dir-regexp
          (format "%s\\|%s"
                  vc-ignore-dir-regexp
                  tramp-file-name-regexp))
    (setq tramp-verbose 1))
#+end_src

*** treesit

**** [[https://github.com/renzmann/treesit-auto][treesit-auto]]

Automatically install and use tree-sitter major modes in Emacs 29+. If the tree-sitter version can’t be used, fall back to the original major mode.

#+begin_src emacs-lisp :name treesit-auto
  (use-package treesit-auto
    :custom
    (treesit-auto-install 'prompt)
    (treesit-auto-langs '(python rust clojure commonlisp bash nim json yaml toml go))
    :config
    (treesit-auto-add-to-auto-mode-alist 'all)
    (global-treesit-auto-mode))
#+end_src

*** visual-line-mode

Visually wrap lines in Emacs.

#+begin_src emacs-lisp :name visual-line-mode
  (setq visual-line-fringe-indicators '(left-curly-arrow right-curly-arrow))
  (global-visual-line-mode)
  (blackout 'visual-line-mode)
#+end_src

*** winner-mode

Allows you to "undo" and "redo" window configuration changes.

#+begin_src emacs-lisp :name winner-mode
  ;; Ignore all the *<name>* buffers by regex.
  (setq winner-boring-buffers-regexp "^\\*")
  (winner-mode +1)
#+end_src

*** ztree

#+begin_src emacs-lisp :name ztree
  (use-package ztree)
#+end_src

** Emacs Enhancements
*** [[https://github.com/abo-abo/ace-window][ace-window]]

Selecting a window/frame to switch to

#+begin_src emacs-lisp :name ace-window
  (use-package ace-window
    :bind (("C--" . ace-window))
    :init
    (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l)
          aw-leading-char-style 'path
          aw-background t
          aw-dispatch-always t)
    :config
    (set-face-attribute 'aw-leading-char-face nil :height 4.0))
#+end_src

*** [[https://github.com/abo-abo/ace-link][ace-link]]

Select a link to jump to in Info, help, woman, org or eww modes

#+begin_src emacs-lisp :name ace-link
   (use-package ace-link
     :init (ace-link-setup-default))
#+end_src

*** [[https://github.com/Silex/docker.el][docker.el]]

Emacs integration for docker - containers, images, networks, contexts & docker-compose.

#+begin_src emacs-lisp :name docker.el
  ;; NOTE: If problems w/ TRAMP are encountered, add >> (setq docker-open-hook '())
  (use-package docker
    :ensure t
    :bind ("C-c d" . docker))
#+end_src

*** [[https://github.com/lccambiaghi/vanilla-emacs#dont-close-windows-on-escape][don't-close-windows-on-escape]]

Sometimes ESC kills my window layout. This advice prevents that from happening.
Found here: https://www.lucacambiaghi.com/vanilla-emacs/readme.html#h:8BB05594-D909-4E99-960B-5624F915E664

#+begin_src emacs-lisp :name emacs
  (use-package emacs
    :ensure nil
    :config
    (defadvice keyboard-escape-quit
        (around keyboard-escape-quit-dont-close-windows activate)
      (let ((buffer-quit-function (lambda () ())))
        ad-do-it)))
#+end_src

*** [[https://github.com/skeeto/elfeed][Elfeed]]

    b: Open the article in the browser
    G: Fetch feed updates from the servers
    s: Update the search filter
    c: Clear the search filter
    r Mark the entry as read
    u: Mark the entry as unread
    g: Refresh view of the feed listing (remove unread items)
    q: Quit the browser

#+begin_src emacs-lisp :name elfeed
  (use-package elfeed
    :custom
    ;; Prefer the curl we install via homebrew
    (elfeed-curl-program-name "/opt/homebrew/opt/curl/bin/curl")
    (elfeed-db-directory (expand-file-name "elfeed" user-emacs-directory))
    (elfeed-show-entry-switch 'display-buffer)
    (elfeed-feeds '(("http://www.reddit.com/r/emacs.rss" emacs)
                    ("https://planet.emacslife.com/atom.xml" emacs)
                    ("https://xkcd.com/rss.xml" fun)))
    :bind
    (("C-c e" . elfeed )))

   (defun my-elfeed-mark-all-read ()
     (interactive)
     (elfeed-untag elfeed-search-entries 'unread)
     (elfeed-search-update :force)) ; redraw
#+end_src

*** elfeed-org

#+begin_src emacs-lisp :name elfeed-org
  (use-package elfeed-org
    :after (elfeed)
    :config
    (setq rmh-elfeed-org-files (list (expand-file-name deftpunk--etc-dir "elfeed.org")))
    (elfeed-org))
#+end_src

*** [[https://github.com/magnars/expand-region.el][expand-region]]

Expand the selected region by semantic units.

#+begin_src emacs-lisp :name expand-region
  (use-package expand-region
    :bind ("C-=" . er/expand-region))
#+end_src

*** [[https://github.com/Malabarba/emacs-google-this][google-this]]

A set of emacs functions and bindings to google under point.

#+begin_src emacs-lisp :name google-this
  (use-package google-this)
#+end_src

*** indent-bars

Highlight indentation.  You need to have =:stipple= support in your Emacs first.

#+begin_src emacs-lisp :name indent-bars
  (use-package indent-bars
    :ensure (indent-bars :type git :host github :repo "jdtsmith/indent-bars")
    :custom
    (indent-bars-no-descend-lists t) ; no extra bars in continued func arg lists
    (indent-bars-treesit-support t)
    (indent-bars-treesit-ignore-blank-lines-types '("module"))
    ;; Add other languages as needed
    (indent-bars-treesit-scope '((python function_definition class_definition for_statement
        if_statement with_statement while_statement)))
    ;; Note: wrap may not be needed if no-descend-list is enough
    ;;(indent-bars-treesit-wrap '((python argument_list parameters ; for python, as an example
    ;;				      list list_comprehension
    ;;				      dictionary dictionary_comprehension
    ;;				      parenthesized_expression subscript)))
    :hook ((python-base-mode yaml-mode) . indent-bars-mode))
#+end_src

*** [[https://github.com/emacsfodder/move-text][move-text]]

Move the current line or region

#+begin_src emacs-lisp :name move-text
  (use-package move-text
    :config
    (defun indent-region-advice (&rest ignored)
      "Indent after moving"
      (let ((deactivate deactivate-mark))
        (if (region-active-p)
            (indent-region (region-beginning) (region-end))
          (indent-region (line-beginning-position) (line-end-position)))
        (setq deactivate-mark deactivate)))

    (advice-add 'move-text-up :after 'indent-region-advice)
    (advice-add 'move-text-down :after 'indent-region-advice))

  ;; Cuz general won't  add these as part of use-package declaration??
  (global-set-key (kbd "s-C-j") #'move-text-down)
  (global-set-key (kbd "s-C-k") #'move-text-up)

#+end_src

*** [[https://github.com/emacsorphanage/osx-trash][osx-trash]]

Make =delete-by-moving-to-trash= do what we expect on MacOSX. Don't forget to =brew install trash= for better performance.

#+begin_src emacs-lisp :name osx-trash
  (use-package osx-trash
    :config
    (when (eq system-type 'darwin)
      (osx-trash-setup))
    (setq delete-by-moving-to-trash t))
#+end_src

*** [[https://github.com/purcell/page-break-lines][page-break-lines]]

Dispaly ugly form feed characters as tidy horizontal rules.

#+begin_src emacs-lisp :name page-break-lines
  (use-package page-break-lines
    :blackout t
    :hook (text-mode . page-break-lines-mode))
#+end_src

*** [[https://github.com/nex3/perspective-el][perspective.el]]

"Workspaces" for Emacs.

An overview of [[https://github.com/nex3/perspective-el?tab=readme-ov-file#similar-packages][similar packages]] tldr:

#+begin_src emacs-lisp :name perspective
  (use-package perspective
    :hook (kill-emacs-hook . persp-state-save)
    :bind (("C-x b" . persp-switch-to-buffer*)
           ("C-x k" . persp-kill-buffer*)
           ("C-x C-b" . persp-list-buffers))         ; or use a nicer switcher, see below
    :custom
    (persp-initial-frame-name "Main Perspective")
    (persp-state-default-file "~/.emacs.d/.perspective-state")
    (persp-mode-prefix-key (kbd "s-p"))  ; pick your own prefix key here
    :init
    (persp-mode))
#+end_src

*** [[https://github.com/bbatsov/projectile][projectile]]

Project management for Emacs

#+begin_src emacs-lisp :name projectile
    (use-package projectile
      :bind (:map projectile-mode-map
    ;;              ("s-p" . projectile-command-map)
                  ("C-c p" . projectile-command-map))
      :init
      (setq
       ;; Auto-discovery is slow to do by default. Better to update the list
       ;; when you need to (`projectile-discover-projects-in-search-path').
       projectile-project-search-path '("~/WorkStuff/eig")
       projectile-completion-system 'default
       projectile-auto-discover t
       projectile-enable-caching t
       projectile-globally-ignored-files '(".DS_Store" "TAGS")
       projectile-globally-ignored-file-suffixes '(".elc" ".pyc" ".o")
       projectile-kill-buffers-filter 'kill-only-files
       projectile-ignored-projects '("~/" "/tmp"))

      (setq projectile-cache-file (expand-file-name "projectile.cache" deftpunk--var-dir)
            projectile-known-projects-file (expand-file-name "projectile-known-projects.eld"
                                                             deftpunk--var-dir))
      ;; Do not include the straight repos
      (setq projectile-ignored-project-function
            (lambda (project-root)
              (string-prefix-p (expand-file-name "straight/" user-emacs-directory) project-root)))

      (global-set-key [remap find-tag]         #'projectile-find-tag)

      (projectile-mode +1))
#+end_src

**** [[https://gitlab.com/OlMon/consult-projectile][consult-projectile]]

Incorporate projectile into consult

#+begin_src emacs-lisp :name consult-projectile
  (use-package consult-projectile
    ;; :bind (("s-p" . consult-projectile))
    :ensure (consult-projectile :type git :host gitlab :repo "OlMon/consult-projectile" :branch "master"))
#+end_src

**** [[https://github.com/bbatsov/persp-projectile][persp-projectile]]

Integrate perspective and projectile so that a project is also a perspective.

#+begin_src emacs-lisp :name persp-projectile
  (use-package persp-projectile
    :config
    (require 'persp-projectile))
#+end_src

*** [[https://github.com/Kungsgeten/selected.el][selected.el]]

Keybindings you want enabled when a region is active.

#+begin_src emacs-lisp :name selected
  (use-package selected
    :commands selected-minor-mode
    :init
    (setq selected-org-mode-map (make-sparse-keymap))
    :bind (:map selected-keymap
                ("q" . selected-off)
                ("u" . upcase-region)
                ("d" . downcase-region)
                ("m" . apply-macro-to-region-lines)
                :map selected-org-mode-map
                ("t" . org-table-convert-region)))
#+end_src

*** [[https://github.com/hrehfeld/emacs-smart-hungry-delete][smart-hungry-delete]]

Org mode overrides everything so smart-hungry-delete will not be happening in Org files; so that tables align properly.

#+begin_src emacs-lisp :name smart-hungry-delete
  (use-package smart-hungry-delete
    :bind (([remap backward-delete-char-untabify] . smart-hungry-delete-backward-char)
           ([remap delete-backward-char] . smart-hungry-delete-backward-char)
           ([remap delete-char] . smart-hungry-delete-forward-char))
    :init (smart-hungry-delete-add-default-hooks))
#+end_src

*** [[https://github.com/Fuco1/smartparens][smartparens]]

Keep my pairs clean-ish.

https://ebzzry.com/en/emacs-pairs/ - comprehensive article about smartparens and bindings.

#+begin_src emacs-lisp :name smartparens
  (use-package smartparens
    :commands (sp-local-pair)
    :hook (prog-mode . smartparens-mode)
    :config
    ;; smartparens doesn't recognize the sly-mrepl-mode
    (add-to-list 'sp-lisp-modes 'sly-mrepl-mode)

    ;; load the default smartparens rules for various languages.
    (require 'smartparens-config)

    ;; Overlays are too distracting and not terribly helpful. show-parens does
    ;; this for us already (and is faster), so...
    (setq sp-highlight-pair-overlay nil
          sp-highlight-wrap-overlay nil
          sp-highlight-wrap-tag-overlay nil)

    ;; The default is 100, because smartparen's scans are relatively expensive
    ;; (especially with large pair lists for some modes), we reduce it, as a
    ;; better compromise between performance and accuracy.
    (setq sp-max-prefix-length 25)
    ;; No pair has any business being longer than 4 characters; if they must, set
    ;; it buffer-locally. It's less work for smartparens.
    (setq sp-max-pair-length 4)
    ;; This isn't always smart enough to determine when we're in a string or not.
    ;; See https://github.com/Fuco1/smartparens/issues/783.
    (setq sp-escape-quotes-after-insert nil)

    ;; Silence some harmless but annoying echo-area spam
    (dolist (key '(:unmatched-expression :no-matching-tag))
      (setf (alist-get key sp-message-alist) nil))

    ;; You're likely writing lisp in the minibuffer, therefore, disable these
    ;; quote pairs, which lisps doesn't use for strings:
    (sp-local-pair 'minibuffer-inactive-mode "'" nil :actions nil)
    (sp-local-pair 'minibuffer-inactive-mode "`" nil :actions nil))
#+end_src

*** [[https://github.com/bbatsov/super-save][super-save]]

Auto-saves your buffers  when certain events happen.

#+begin_src emacs-lisp :name super-save
  (setq auto-save-default nil) ; turn off the builtin auto-save
  (use-package super-save
    :blackout t
    :custom
    (super-save-silent t)
    (super-save-delete-trailing-whitespace t)
    (super-save-remote-files nil)
    (super-save-auto-save-when-idle t)
    (super-save-exclude '(".gpg"))
    :config
    (add-to-list 'super-save-triggers 'ace-window)
    (add-to-list 'super-save-hook-triggers 'find-file-hook)
    (super-save-mode +1))
#+end_src

*** [[https://github.com/liushihao456/symbols-outline.el][bsymbols-outline]]

#+begin_src emacs-lisp :name symbols-outline
  (use-package symbols-outline
    :config
    (setq symbols-outline-fetch-fn #'symbols-outline-lsp-fetch
          symbols-outline-window-position 'left)
    (symbols-outline-follow-mode))
#+end_src

*** [[https://github.com/emacsorphanage/transpose-frame][transpose-frame]]

Transpose windows arrangement inside a frame.  I use it to toggle vertical/horizontal window splits - currently lives in the emacsorphanage.

#+begin_src emacs-lisp :name transpose-frame
  (use-package transpose-frame
    :bind
    (("C-x 4 t" . transpose-frame)
     ("C-x 4 r" . rotate-frame-clockwise))
    :config)
#+end_src

*** [[https://github.com/Alexander-Miller/treemacs][treemacs]]

Default keybindings: https://github.com/Alexander-Miller/treemacs?tab=readme-ov-file#default-keymaps

#+begin_src emacs-lisp :name treemacs
  (use-package treemacs
    :ensure t
    :commands (treemacs-follow-mode
               treemacs-filewatch-mode
               treemacs-fringe-indicator-mode
               treemacs-git-mode)
    :init
    (setq treemacs-missing-project-action  'remove
          treemacs-sorting                 'alphabetic-asc
          treemacs-follow-after-init       t
          treemacs-width                   35)
    :config
    (treemacs-follow-mode t)
    (treemacs-filewatch-mode t))

  (use-package treemacs-magit
    :ensure t
    :after magit
    :commands treemacs-magit--schedule-update
    :hook ((magit-post-commit
            git-commit-post-finish
            magit-post-stage
            magit-post-unstage)
           . treemacs-magit--schedule-update))
#+end_src

*** tree-sitter and tree-sitter-langs

*** [[https://github.com/emacsmirror/undo-fu][undo-fu]]

Simple, stable linear undo with redo for Emacs.

#+begin_src emacs-lisp :name undo-fu
  (use-package undo-fu)
#+end_src

*** [[https://github.com/emacsmirror/undo-fu-session][undo-fu-session]]

#+begin_src emacs-lisp :name unfo-fu-session
  (use-package undo-fu-session
    :config
    (setq undo-fu-session-incompatible-files '("/COMMIT_EDITMSG\\'" "/git-rebase-todo\\'"))
    (undo-fu-session-global-mode))
  (elpaca-wait)
#+end_src

*** [[https://github.com/purcell/unfill][unfill]]

Funtions providing the inverse of =fill-paragraph= & =fill-region= .  I most care about =unfill-toggle=

#+begin_src emacs-lisp :name unfill
  (global-unset-key (kbd "M-u"))
  (use-package unfill
    :bind
    (("M-u" . unfill-toggle)))
#+end_src

*** [[https://github.com/k-talo/volatile-highlights.el][volatile-highlights]]

Visual feedback to some operations.


  (use-package volatile-highlights
    :defer t
    :ensure t
    :hook ((prog-mode text-mode) . volatile-highlights-mode)
    :config)


*** [[https://github.com/casouri/vundo][vundo]]

Vundo (visual undo) displays the undo history as a tree and lets you move in the tree to go back to
previous buffer states.

#+begin_src emacs-lisp :name vundo
  (use-package vundo
    :commands (vundo)
    :ensure (vundo :type git :host github :repo "casouri/vundo")
    :custom
    ;; Take less on-screen space.
    (vundo-compact-display t)
    :config

    ;; Better contrasting highlight.
    (custom-set-faces
      '(vundo-node ((t (:foreground "#808080"))))
      '(vundo-stem ((t (:foreground "#808080"))))
      '(vundo-highlight ((t (:foreground "#FFFF00")))))

    ;; Use `HJKL` VIM-like motion, also Home/End to jump around.
    (define-key vundo-mode-map (kbd "l") #'vundo-forward)
    (define-key vundo-mode-map (kbd "<right>") #'vundo-forward)
    (define-key vundo-mode-map (kbd "h") #'vundo-backward)
    (define-key vundo-mode-map (kbd "<left>") #'vundo-backward)
    (define-key vundo-mode-map (kbd "j") #'vundo-next)
    (define-key vundo-mode-map (kbd "<down>") #'vundo-next)
    (define-key vundo-mode-map (kbd "k") #'vundo-previous)
    (define-key vundo-mode-map (kbd "<up>") #'vundo-previous)
    (define-key vundo-mode-map (kbd "<home>") #'vundo-stem-root)
    (define-key vundo-mode-map (kbd "<end>") #'vundo-stem-end)
    (define-key vundo-mode-map (kbd "q") #'vundo-quit)
    (define-key vundo-mode-map (kbd "C-g") #'vundo-quit)
    (define-key vundo-mode-map (kbd "RET") #'vundo-confirm)

    (global-define-key (kbd "C-M-u") 'vundo))
#+end_src

*** [[https://github.com/mhayashi1120/Emacs-wgrep][wgrep]]

Allows you to edit a "grep" buffer and apply those changes to the file buffer(s).

You can edit the text in the grep buffer after typing C-c C-p . After that the changed text is highlighted. The following keybindings are defined:

    =C-c C-e=: Apply the changes to file buffers.
    =C-c C-u=: All changes are unmarked and ignored.
    =C-c C-d=: Mark as delete to current line (including newline).
    =C-c C-r=: Remove the changes in the region (these changes are not applied to the files. Of course, the remaining changes can still be applied to the files.)
    =C-c C-p=: Toggle read-only area.
    =C-c C-k=: Discard all changes and exit.
    =C-x C-q=: Exit wgrep mode.

To save all buffers that wgrep has changed, run

    =M-x wgrep-save-all-buffers=

#+begin_src emacs-lisp :name wgrep
  (use-package wgrep
    :ensure t
    :bind (:map grep-mode-map
                ("e" . wgrep-change-to-wgrep-mode)
                ("C-x C-q" . wgrep-change-to-wgrep-mode)
                ("C-c C-c" . wgrep-finish-edit)))
#+end_src

*** [[https://github.com/hlissner/ws-butler][ws-butler]]

The Doom Emacs fork of ws-butler.

Unobtrusively trim spaces from the end of a line on save.

#+begin_src emacs-lisp :name ws-butler
  (use-package ws-butler
    :ensure (ws-butler :type git :host github :repo "hlissner/ws-butler")
    :blackout t
    :hook ((text-mode . ws-butler-mode)
           (prog-mode . ws-butler-mode))
    :custom
    (ws-butler-keep-whitespace-before-point nil))

  ;; show trailing whitespace
  (setq show-trailing-whitespace t)

  (with-eval-after-load 'ws-butler
    (blackout 'ws-butler-mode))
#+end_src

*** [[https://github.com/mrkkrp/zzz-to-char][zzz-to-char]]

=zzz-to-char= & =zzz-up-to-char= -> Zap to char and zap up to char but you get to pick which char.

TODO: Find a keybinding.

#+begin_src emacs-lisp :name zzz-to-char
  (use-package zzz-to-char)
#+end_src

** Help and documentation enhancements

*** [[https://github.com/blahgeek/emacs-devdocs-browser][emacs-devdocs-browser]]

#+begin_src emacs-lisp :name emacs-devdocs-browser
  (use-package devdocs-browser
    :commands (devdocs-browser-open)
    :general ("C-h D" #'devdocs-browser-open))
#+end_src

*** [[https://github.com/Wilfred/helpful][Helpful]]

Provide more contextual information in Emacs help

#+begin_src emacs-lisp :name helpful
  (use-package helpful
    :general
    ([remap describe-function]  #'helpful-callable
     [remap describe-command]   #'helpful-command
     [remap describe-variable]  #'helpful-variable
     [remap display-local-help] #'helpful-at-point
     [remap describe-symbol]    #'helpful-symbol
     [remap describe-key]       #'helpful-key
     "C-h x"                    #'helpful-macro))
#+end_src

** Org

*** Org Configuration

#+begin_src emacs-lisp :name OrgConfiguration
    ;; Make all the lines soft-wrap
    (use-package org
      :ensure nil
      :blackout (org-mode . " Org")
      :hook (org-mode . (lambda ()
              (toggle-truncate-lines nil)))
      :general
      (:keymaps 'org-mode-map
            "C-c C-'" 'org-edit-special)
      (:keymaps 'org-src-mode-map
            "C-c C-'" 'org-edit-src-exit)
      :custom
      (org-use-speed-commands t)      ; faster navigation
      (org-fontify-quote-and-verse-blocks t)    ; quote/verse blocks show up better
      (org-return-follows-link t)
      (org-src-fontify-natively t)
      (org-startup-indented t)
      (org-pretty-entities t)
      (org-hide-emphasis-markers t)       ; show italicized text instead of /italicized text/
      (org-startup-with-inline-images t)
      (org-image-actual-width '(300))
      :init
      ;; Load markdown as well as emacs-lisp
      ;; Add/Create function for executing markdown or send to previewer
      (org-babel-do-load-languages
       'org-babel-load-languages
       '((emacs-lisp . t)
         (python . t)))
      :config
      ;; Moving general bindings here to reduce startup penalty.

      ;; Create a sparse tree view of TODOs in the current Org buffer.
      ;; https://stackoverflow.com/a/63195446
      ;; You can use C-x 4 0 to kill the buffer and window when done.
      (defun org-todo-buffer ()
        "Create new indirect buffer with sparse tree of undone TODO items"
        (interactive)
        (clone-indirect-buffer "*org TODO undone*" t)
        (org-show-todo-tree nil) ; mimics interactive usage
        (org-remove-occur-highlights))

      ;; Keys for org-mode-map
      (general-define-key
       :keymaps 'org-mode-map
       ;; so that C-j actually is mapped to avy-goto-char-timer
       "C-j" 'nil
       "C-k" 'nil
       ;; so that we can use it as help prefix
       "M-h" 'nil)

      ;; Local leader bindings.
      (deftpunk-local-leader-def
        :keymaps 'org-mode-map
        "a" '(org-todo-buffer :which-key "Show TODOs for current buffer.")
        "d" '(org-todo :which-key "Org Todo + Todo States")
        "e" '(org-edit-special :which-key "Edit blk in special buffer")
        "h" '(consult-org-heading :which-key "Find Org heading in current buffer.") ; https://github.com/minad/consult/blob/main/consult-org.el
        "i" '(org-insert-link :which-key "Org Insert link")
        "n" '(org-babel-next-src-block :which-key "Go to the next src block")
        "o" '(ace-link-org :which-key "Links in Org mode document")
        "p" '(org-babel-previous-src-block :which-key "Go to previous src block")
        "s" '(org-insert-structure-template :which-key "Insert templates")
        "t" '(org-babel-tangle :which-key "Tangle the src blocks")
        "u" '(org-babel-goto-src-block-head :which-key "Go to the head of the src block")
        "x" '(org-open-at-point :which-key "Open link at point")
        "y" '(org-download-screenshot file :which-key "Yank screenshot"))
      )

    ;; More "keep off my modeline"
    (with-eval-after-load 'org-indent
      (blackout 'org-indent-mode))
#+end_src

*** Org Src

#+begin_src emacs-lisp :name org-src
  (defun dftpnk-org-src-mode ()
    (smartparens-mode)
    (rainbow-delimiters-mode t))

  (add-hook 'org-src-mode-hook #'dftpnk-org-src-mode)
#+end_src

*** [[https://github.com/awth13/org-appear][org-appear]]

Since we hide the emphasis markers in Org mode, this makes them show up when the cursor is on the
emphasized word.

#+begin_src emacs-lisp :name org-appear
  (use-package org-appear
    :blackout t
    :hook (org-mode . org-appear-mode)
    :custom
    (org-appear-autolinks t)
    (org-appear-autosubmarkers t)
    (org-appear-autoentities t)
    (org-appear-auto-keywards))
#+end_src

*** [[https://github.com/yilkalargaw/org-auto-tangle][org-auto-tangle]]

Automatically tangle your org files if you have =#+auto_tangle: t= in your org file. This is mainly for this Org config file.

Bonus: The tangle is async.

#+begin_src emacs-lisp :org-auto-tangle
  (use-package org-auto-tangle
    :hook (org-mode . org-auto-tangle-mode))

  ;; The joys of hooks and loading.
  (with-eval-after-load 'org-auto-tangle
    (blackout 'org-auto-tangle-mode))
#+end_src

*** [[https://github.com/minad/org-modern][org-modern]]

Implements a "modern" style for Org buffers.

#+begin_src emacs-lisp :name org-modern
  ;; https://github.com/minad/org-modern/issues/106#issuecomment-1344659316
  ;; Fixes issue mentioned above
  (defun disable-point-adjustment (&rest args)
    (setq disable-point-adjustment t))
  (advice-add 'org-beginning-of-line :after #'disable-point-adjustment)

  (use-package org-modern
    :blackout
    :after org
    :init
    (setq org-modern-hide-stars nil
          ;; I prefer just the circle
          org-modern-star '("○" "○" "○" "○" "○" "○")
          org-auto-align-tags nil
          org-tags-column 0
          org-catch-invisible-edits 'show-and-error
          org-special-ctrl-a/e t
          org-insert-heading-respect-content t

          ;; Org styling, hide markup etc.
          org-ellipsis "…"

          ;; Agenda styling
          org-agenda-tags-column 0
          org-agenda-block-separator ?─
          org-agenda-time-grid
          '((daily today require-timed)
            (800 1000 1200 1400 1600 1800 2000)
            " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
          org-agenda-current-time-string
          "⭠ now ─────────────────────────────────────────────────")
    :config
    (global-org-modern-mode))
#+end_src

** TODO: Org-roam

** Security

#+begin_src emacs-lisp :name security
  (setenv "GPG_AGENT_INFO" nil)
  (setq epg-gpg-program "gpg2")
#+end_src

** Source Control
*** [[https://github.com/Artawower/blamer.el][blamer]]

A git blame plugin

#+begin_src emacs-lisp :name blamer
    (use-package blamer
      :ensure (:host github :repo "artawower/blamer.el")
      :bind (("C-c i" . blamer-show-commit-info))
             ;("C-c i" . blamer-show-posframe-commit-info))
      :custom
      (blamer-idle-time 0.3)
      (blamer-min-offset 70)
      :custom-face
      (blamer-face ((t :foreground "#7a88cf"
                        :background nil
                        :height 120
                        :italic t)))
      :config
      (global-blamer-mode 1))
#+end_src

*** [[https://github.com/rmuslimov/browse-at-remote][browse-at-remote]]

Open a link to a file in github.com/github.hpe.com repository.

#+begin_src emacs-lisp :name browse-at-remote
  (use-package browse-at-remote
    :commands (browse-at-remote)
    :general ("C-c g g" #'browse-at-remote)
    :config
    ;; Add the HPE github.
    (add-to-list 'browse-at-remote-remote-type-regexps
                 `(:host ,(rx bol "github.hpe.com" eol)
                         :type "github"
                         :actual-host "github.hpe.com")))
#+end_src

*** [[https://github.com/dgutov/diff-hl][diff-hl]]

A maintained indicator of git status on the left of the buffer - is supposed to work better with Tramp as well.

`diff-hl-stage-current-hunk`

#+begin_src emacs-lisp :name diff-hl
  ;; From Doom Emacs ui/vc-gutter/config.el
  ;; UI: make the fringe small enough that the diff bars aren't too domineering,
  ;;   while leaving enough room for other indicators.
  (if (fboundp 'fringe-mode) (fringe-mode '8))
  ;; UI: the gutter looks less cramped with some space between it and  buffer.
  (setq-default fringes-outside-margins t)

  (use-package diff-hl
    :hook ((find-file . diff-hl-mode)
           (vc-dir-mode . diff-hl-dir-mode)
           (dired-mode . diff-hl-dired-mode)
           (magit-pre-refresh . diff-hl-magit-pre-refresh)
           (magit-post-refresh . diff-hl-magit-post-refresh))
    :custom
    (diff-hl-draw-borders nil)
    :config

    ;; From Doom:
    ;; PERF: A slightly faster algorithm for diffing.
    (setq vc-git-diff-switches '("--histogram"))
    ;; PERF: Slightly more conservative delay before updating the diff
    (setq diff-hl-flydiff-delay 0.5)  ; default: 0.3
    ;; PERF: don't block Emacs when updating vc gutter
    (setq diff-hl-update-async t)

    ;; UX: get realtime feedback in diffs after staging/unstaging hunks.
    (setq diff-hl-show-staged-changes nil)
    (global-diff-hl-mode))
#+end_src

*** [[https://github.com/emacsorphanage/git-gutter][git-gutter]] & [[https://github.com/emacsorphanage/git-gutter-fringe][git-gutter-fringe]]

Highlighting uncommitted changes in the buffer.

TODO: set faces.



  (use-package git-gutter
    :hook ((org-mode . git-gutter-mode)
           (org-src-mode . git-gutter-mode)
           (prog-mode . git-gutter-mode)
           (markdown-mode . git-gutter-mode))
    :custom
    (git-gutter:update-interval 0.05)
    (git-gutter:disabled-modes '(fundamental-mode image-mode pdf-vew-mode))
    ;; Don't go looking for backends I don't use.
    (git-gutter:handled-backends '(git))
    ;; Don't ask to commit/revert
    (git-gutter:ask-p nil)
    :config
    ;; UX: update git-gutter on focus (in case I was using git externally)
    (add-hook 'focus-in-hook #'git-gutter:update-all-windows)

    ;; Stop git-gutter doing things when we don't want
    (remove-hook 'post-command-hook #'git-gutter:post-command-hook)
    (advice-remove #'quit-window #'git-gutter:quit-window)
    (advice-remove #'switch-to-buffer #'git-gutter:switch-to-buffer)

    (defhydra hydra-git-gutter (:body-pre (git-gutter-mode 1)
                                          :hint nil)
      "
   Git gutter:
     _j_: next hunk        _s_tage hunk     _q_uit
     _k_: previous hunk    _r_evert hunk    _Q_uit and deactivate git-gutter
     ^ ^                   _p_opup hunk
     _h_: first hunk
     _l_: last hunk        set start _R_evision
   "
      ("j" git-gutter:next-hunk)
      ("k" git-gutter:previous-hunk)
      ("h" (progn (goto-char (point-min))
                  (git-gutter:next-hunk 1)))
      ("l" (progn (goto-char (point-min))
                  (git-gutter:previous-hunk 1)))
      ("s" git-gutter:stage-hunk)
      ("r" git-gutter:revert-hunk)
      ("p" git-gutter:popup-hunk)
      ("R" git-gutter:set-start-revision)
      ("q" nil :color blue)
      ("Q" (progn (git-gutter-mode -1)
                  ;; git-gutter-fringe doesn't seem to
                  ;; clear the markup right away
                  (sit-for 0.1)
                  (git-gutter:clear))
       :color blue)))
#+end_src

  (use-package git-gutter-fringe
    :config
    ;; Make added/modified a bar & deleted a triangle.
    (define-fringe-bitmap 'git-gutter-fr:added [#b11100000] nil nil '(center repeated))
    (define-fringe-bitmap 'git-gutter-fr:modified [#b11100000] nil nil '(center repeated))
    (define-fringe-bitmap 'git-gutter-fr:deleted
      [#b10000000
       #b11000000
       #b11100000
       #b11110000] nil nil 'bottom))

  ;; Turn off git-gutter in the modeline.
  (blackout 'git-gutter-mode)

*** [[https://github.com/sshaw/git-link][git-link]]

Create URLs for files and commits

#+begin_src emacs-lisp :name git-link
  (use-package git-link
    :bind (("C-c g l" . 'git-link)))
#+end_src

*** [[https://githubkj.com/magit/git-modes][git-modes]]

Major modes for various Git config files: .gitconfig, .gitattributes, .gitignore, etc.

#+begin_src emacs-lisp :name git-modes
(use-package git-modes
  :config
  ;; This works for .dockerignore and other .*ignore files as well.
  (dolist (pattern '("/.dockeringnore\\'"))
    (add-to-list 'auto-mode-alist (cons pattern #'gitignore-mode))))
#+end_src

*** [[https://gitlab.com/pidu/git-timemachine][git-timemachine]]

Step through historic versions of a git controlled file.

Visit a git-controlled file and issue M-x git-timemachine (or bind it to a keybinding of your
choice). If you just need to toggle the time machine you can use M-x git-timemachine-toggle.

Use the following keys to navigate historic version of the file

p Visit previous historic version
n Visit next historic version
w Copy the abbreviated hash of the current historic version
W Copy the full hash of the current historic version
g Goto nth revision
t Goto revision by selected commit message
q Exit the time machine.
b Run magit-blame on the currently visited revision (if magit available).
c Show current commit using magit (if magit available).

#+begin_src emacs-lisp :name git-timemachine
    (use-package git-timemachine
      :config
      (setq git-timemachine-abbreviation-length 14
            git-timemachine-show-minibuffer-details t)
      (elpaca-wait))

    ;; From redguardtoo - http://blog.binchen.org/posts/new-git-timemachine-ui-based-on-ivy-mode.html
    (defun my-git-timemachine-show-selected-revision ()
      "Show last (current) revision of file."
      (interactive)
      (let (collection)
        (setq collection
              (mapcar (lambda (rev)
                        ;; re-shape list for the ivy-read
                        (cons (concat (substring (nth 0 rev) 0 7) "|" (nth 5 rev) "|" (nth 6 rev)) rev))
                      (git-timemachine--revisions)))
        (ivy-read "commits:"
                  collection
                  :action (lambda (rev)
                            (git-timemachine-show-revision rev)))))

    (defun my-git-timemachine ()
      "Open git snapshot with the selected version.  Based on ivy-mode."
      (interactive)
      (unless (featurep 'git-timemachine)
        (require 'git-timemachine))
      (git-timemachine--start #'my-git-timemachine-show-selected-revision))
#+end_src

*** [[https://github.com/redguardtoo/vc-msg][vc-msg]]

A maintained version of git-messenger

- Run *vc-msg-show* from magit blame buffer to show commit info.

#+begin_src emacs-lisp :name vc-msg
  (use-package sideline-blame)
  ;; Show the commit message for the current line.
  (use-package sideline
    :init
    (setq sideline-backends-left '((sideline-blame . down))))

  (use-package vc-msg
    :init
    (setq vc-msg-force-vcs "git"))
#+end_src

** LSP

Comparison of the various providers -> https://www.reddit.com/r/emacs/comments/1c0v28k/lspmode_vs_lspbridge_vs_lspce_vs_eglot/

*** [[https://github.com/emacs-lsp/lsp-mode][lsp-mode]]

- M-x lsp-rename
- M-x lsp-execute-code-action / C-c C-c a

https://emacs-lsp.github.io/lsp-mode/tutorials/how-to-turn-off/

#+begin_src emacs-lisp :name lsp-mode
  (use-package lsp-mode
    :commands (lsp lsp-deferred)
    :hook (((python-mode python-ts-mode) . lsp)
           (clojure-mode . lsp-deferred))
    :hook (lsp-mode . lsp-enable-which-key-integration)
    :custom
    (lsp-completion-provider :company)
    (lsp-completion-show-detail t)
    (lsp-competion-show-kind t)
    (lsp-keymap-prefix "C-c l")
    (lsp-enable-symbol-highlighting t)
    (lsp-lens-enable t)
    (lsp-headerline-breadcrumb-enable t)
    (lsp-diagnostics-provider :flycheck)
    (lsp-completion-show-detail t)
    (lsp-completion-show-kind t))

  ;; lsp-clients
  ;; TODO: pyright on VDT
  ;; (lsp-register-client
   ;; (make-lsp-client :new-connection (lsp-tramp-connection "pyright")
   ;;                  :major-modes '(python-mode python-ts-mode)
   ;;                  :remote? t
   ;;                  :server-id 'pyright-vdt))

  (use-package lsp-pyright
    :ensure t
    :hook ((python-mode python-ts-mode) . (lambda ()
                                            (require 'lsp-pyright)
                                            (lsp))))  ; or lsp-deferred
#+end_src

*** [[https://github.com/emacs-lsp/lsp-ui][lsp-ui]]

Higher level UI elements for lsp-mode, e.g. flycheck support, code lenses.

#+begin_src emacs-lisp :name lsp-ui
  (use-package lsp-ui
    :commands (lsp-ui-mode)
    :general
    (:keymaps 'lsp-ui-mode-map
              [remap xref-find-definitions] #'lsp-ui-peek-find-definitions
              [remap xref-find-references] #'lsp-ui-peek-find-references)
    :hook (lsp-mode . lsp-ui-mode)
    :config
    (setq lsp-ui-doc-position 'bottom
          lsp-ui-doc-header t
          lsp-ui-peek-enable t
          lsp-ui-peek-always-show t
          lsp-ui-sideline-show-hover t
          lsp-ui-sideline-show-diagnostics t
          lsp-ui-doc-include-signature t))
#+end_src

*** [[https://github.com/emacs-lsp/lsp-ivy][lsp-ivy]]

Ivy interface to workspace symbol functionality offered by `lsp-mode`.

- lsp-ivy-workspace-symbol
- lsp-ivy-global-workspace-symbol

#+begin_src emacs-lisp :name lsp-ivy
  (use-package lsp-ivy)
#+end_src

*** [[https://github.com/emacs-lsp/dap-mode/tree/a31f2496605d076d50d49393116f77fbb29f2631][dap-mode]]

https://emacs-lsp.github.io/dap-mode/page/configuration/#python

*** lsp-treemacs

#+begin_src emacs-lisp :name lsp-treemacs
  (use-package lsp-treemacs
    :config
    (lsp-treemacs-sync-mode 1))
#+end_src

*** [[https://github.com/gagbo/consult-lsp][consult-lsp]]

Consult + lsp-mode integration

- consult-lsp-diagnostics
  Select diagnostics from the current workspace
- consult-lsp-symbols
  Select symbols from the current workspace
- consult-lsp-file-symbols
  Select symbols from the current file, similar to consult-line

The different narrowing shortcuts:
;; Lowercase classes
    (?c . "Class")
    (?f . "Field")
    (?e . "Enum")
    (?i . "Interface")
    (?m . "Module")
    (?n . "Namespace")
    (?p . "Package")
    (?s . "Struct")
    (?t . "Type Parameter")
    (?v . "Variable")

    ;; Uppercase classes
    (?A . "Array")
    (?B . "Boolean")
    (?C . "Constant")
    (?E . "Enum Member")
    (?F . "Function")
    (?M . "Method")
    (?N . "Number")
    (?O . "Object")
    (?P . "Property")
    (?S . "String")

    (?o . "Other")

#+begin_src emacs-lisp :name consult-lsp
  (use-package consult-lsp
    :ensure t
    :config
    (define-key lsp-mode-map [remap xref-find-apropos] #'consult-lsp-symbols))
#+end_src

** General Software Development
*** General Configuration

#+begin_src emacs-lisp :name comments
  (defun emacswiki/comment-auto-fill ()
      " Set up auto-file / wrapping of comments."
      (setq-local comment-auto-fill-only-comments t)
      (auto-fill-mode 1))

  ;; Spellchecking in comments.
  (add-hook 'prog-mode-hook #'flyspell-prog-mode)

  ;; Make a buffer executable automatically if its a script
    (add-hook 'after-save-hook
              'executable-make-buffer-file-executable-if-script-p)

  (setq-default display-line-numbers-width 3)
  (setq-default display-line-numbers-widen t)
#+end_src

*** [[https://github.com/davidshepherd7/fill-function-arguments][fill-function-arguments]]

Add/remove line breaks between function arguments and similar constructs

#+begin_src emacs-lisp :name fill-function-arguments
  (use-package fill-function-arguments
    :hook
    ((prog-mode . (lambda ()
                    (local-set-key (kbd "M-q") #'fill-function-arguments-dwim)))
     (emacs-lisp-mode . (lambda ()
                          (setq-local fill-function-arguments-second-argument-same-line t)
                          (setq-local fill-function-arguments-last-argument-same-line t)
                          (setq-local fill-function-arguments-argument-separator " "))))
    :custom
    (fill-function-arguments-indent-after-fill t)
    (fill-function-arguments-indent-first-argument-same-line t))
#+end_src

*** [[https://github.com/DarthFennec/highlight-indent-guides/][highlight-indent-guides]]

Having a discrete indication of the indentation is useful for Python.

#+begin_src emacs-lisp :name highlight-indent-guides
  (use-package highlight-indent-guides
    :blackout t
    :hook (python-mode . highlight-indent-guides-mode)
    :init (setq highlight-indent-guides-method 'character
                highlight-indent-guides-responsive 'top))

  (after! highlight-indent-guides-mode
    (progn
     (set-face-background 'highlight-indent-guides-odd-face "gray48")
     (set-face-background 'highlight-indent-guides-even-face "gray48")
     (set-face-foreground 'highlight-indent-guides-character-face "gray28")
     (set-face-foreground 'highlight-indent-guides-top-character-face "orchid1")))
#+end_src

*** outline-indent.el

foliding for languages that use indentation, e.g. python, yaml

#+begin_src emacs-lisp :name outline-indent
  (use-package outline-indent
    :ensure t
    :custom
    (outline-indent-ellipsis " ▼ ")
    :commands (outline-indent-minor-mode
               outline-indent-insert-heading)
    :hook (((python-mode python-ts-mode) . #'(lambda ()
                                               (setq-local outline-indent-default-offset 4)
                                               (setq-local outline-indent-shift-width 4)
                                               (outline-indent-minor-mode +1)))
           ((yaml-mode yaml-ts-mode) . #'(lambda ()
                                           (setq-local outline-indent-default-offset 2)
                                           (setq-local outline-indent-shift-width 2)
                                           (outline-indent-minor-mode +1)))))
#+end_src

** Lisp Languages
*** lispy

TODO: Enable lispy.

*** Clojure

**** [[https://github.com/clojure-emacs/clojure-mode][Clojure mode]]

#+begin_src emacs-lisp :name clojure-mode
  (use-package clojure-mode
    :hook ((clojure-mode . smartparens-strict-mode)
           (clojure-mode . subword-mode)
           (clojure-mode . rainbow-delimiters-mode))
    :custom
    (clojure-indent-style 'always-align)
    (clojure-align-forms-automatically t)
    )
#+end_src

**** [[https://github.com/clojure-emacs/cider][Cider]]

Docs: [[https://cider.mx/][Cider docs]]

#+begin_src emacs-lisp :name cider
  (use-package cider
    :after clojure-mode
    :ensure t
    :custom
    (cider-enrich-classpath t)
    (cider-connection-message-fn #'cider-random-tip)
    (cider-special-mode-truncate-lines nil)
    (cider-font-lock-dynamically '(macro core function var)))
#+end_src

*** Common Lisp
**** Sly

#+begin_src emacs-lisp :name sly
  (setq inferior-lisp-program "/opt/homebrew/bin/sbcl")
  (use-package sly)

  ;; (defun sbcl-save-sly-and-die ()
  ;;   "Save a sbcl image, even when running from inside Sly.
  ;; This function should only be used in the *inferior-buffer* buffer,
  ;; inside emacs."
  ;;   (mapcar #'(lambda (x)
  ;;               (slynk::close-connection
  ;;                x nil nil))
  ;;           slynk::*connections*)
  ;;   (dolist (thread (remove
  ;;                    (slynk-backend::current-thread)
  ;;                    (slynk-backend::all-threads)))
  ;;     (slynk-backend::kill-thread thread))
  ;;   (sleep 1)
  ;;   (sb-ext:save-lisp-and-die #P"~/your-main-program.exe"
  ;;                             :toplevel #'your-main-function-here
  ;;                             :executable t
  ;;                             :compression t))

  ;; in *sly-inferior-lisp* buffer
  ;; (sbcl-save-sly-and-die)

#+end_src

*** Emacs Lisp

** Nim

#+begin_src emacs-lisp :name nim-mode
  (use-package nim-mode
    :hook ((nim-mode . nimsuggest-mode)
           (nim-mode . subword-mode)
           (nim-mode . rainbow-delimiters-mode))
    :mode (("\\.nim.?\\'" . nim-mode))
    )
#+end_src

** Python
*** Python Configuration

#+begin_src emacs-lisp :name python-mode
  (defun deftpunk/python-mode-hook ()
    "Setting up some basics for Python."
    (setq-local fill-column 105)
    ;; (smartparens-strict-mode)
    (highlight-indent-guides-mode)
    (display-line-numbers-mode 1))

  (use-package python
    :ensure nil
    :mode ((rx ".py" string-end) . python-mode)
    :hook (((python-mode python-ts-mode) . deftpunk/python-mode-hook))
    :config
    (setq-local flycheck-python-pylint-executable "pylint")
    (setq-local flycheck-python-flake8-executable "flake8")

    (setq python-shell-interpreter (executable-find "ipython")
          python-shell-interpreter-args "-i --simple-prompt --no-color-info"
          python-shell-prompt-block-regexp "\\.\\.\\.\\.: "
          python-shell-prompt-output-regexp "Out\\[[0-9]+\\]: "
          python-shell-completion-setup-code
          "from IPython.core.completerlib import module_completion"
          python-shell-completion-string-code
          "';'.join(get_ipython().Completer.all_completions('''%s'''))\n")

    ;; some smartparens "smartness" for single quotes
    ;; (sp-local-pair 'python-mode "'" nil
    ;;                :unless '(sp-point-before-word-p
    ;;                          sp-point-after-word-p
    ;;                          sp-point-before-same-p))
    )

  (deftpunk-local-leader-def
    :keymaps '(python-ts-mode-map python-mode-map)
    "c" '(conda-env-activate :which-key "Activate conda env")
    "d" '(conda-env-deactivate :which-key "Deactivate conda env")
    "t" '(python-pytest-dispatch :which-key "Pytest dispatch")
    )
#+end_src

*** [[https://github.com/necaris/conda.el][conda]]

For working with miniconda and conda environments; which I prefer to other Python virtual environments.

Using with Tramp & Docker:
https://www.reddit.com/r/emacs/comments/kymvrz/emacs_lsp_with_docker_conda/
https://github.com/necaris/conda.el/issues/30

#+begin_src emacs-lisp :name conda
  (use-package conda
    :after python
    :config
    ;; taken from doom
    ;; The location of your anaconda home will be guessed from a list of common
    ;; possibilities, starting with `conda-anaconda-home''s default value (which
    ;; will consult a ANACONDA_HOME envvar, if it exists).
    ;;
    ;; If none of these work for you, `conda-anaconda-home' must be set
    ;; explicitly. Afterwards, run M-x `conda-env-activate' to switch between
    ;; environments
    (or (cl-loop for dir in (list conda-anaconda-home
                                  "~/.miniconda3"
                                  "~/.conda")
                 if (file-directory-p dir)
                 return (setq conda-anaconda-home (expand-file-name dir)
                              conda-env-home-directory (expand-file-name dir)))
        (message "Cannot find Anaconda installation"))
    ;; integration with term/eshell
    (conda-env-initialize-interactive-shells)
    (after! eshell (conda-env-initialize-eshell))

    ;; auto-activation (see below for details)
    ;; (conda-env-autoactivate-mode t)
    ;; automatically activate a conda environment on the opening of a file:
    ;; (add-hook 'find-file-hook (lambda () (when (and (bound-and-true-p conda-project-env-path) (string-match "\\.py\\'" buffer-file-name))
    ;;                                       (conda-env-activate-for-buffer))))

    ;; Add to the modeline so that we know which env is activated.
    (add-to-list 'global-mode-string
                 '(conda-env-current-name (" conda:" conda-env-current-name " "))
                 'append))
#+end_src

*** [[https://github.com/wbolster/emacs-python-pytest][emacs-python-pytest]]

#+begin_src emacs-lisp :name emacs-python-pytest
  (use-package python-pytest
    :hook (python-mode . (lambda ()
                           (when-let ((r (locate-dominating-file default-directory ".gitignore")))
                             (setq python-pytest-executable
                                   (concat "PYTHONPATH=" r " " "pytest"))))))
#+end_src

*** [[https://github.com/glyph/python-docstring-mode][python-docstring-mode]]

Minor mode for editing Python docstrings.  Can handle different formats.

#+begin_src emacs-lisp :name python-docstring-mode
  (use-package python-docstring-mode
    :hook (python-mode . python-docstring-mode)
    :ensure (:host github :repo "glyph/python-docstring-mode" :main "python-docstring.el"))
#+end_src

** Miscellaneous File types
*** [[https://github.com/spotify/dockerfile-mode][Dockerfile]]

A Dockerfile mode for Emacs.
You can use =C-c C-b= to build from the buffer & =C-c M-b= to bypass the build cache.

#+begin_src emacs-lisp :name dockerfile
  (use-package dockerfile-mode
    :mode "Dockerfile.*\\'")
#+end_src

*** Markdown

*** YAML
**** [[https://github.com/yoshiki/yaml-mode][yaml-mode]]

Yaml minor mode.

#+begin_src emacs-lisp :name yaml-mode
  (use-package yaml-mode
    :config
    (add-to-list 'auto-mode-alist '("\\.yml\\'" . yaml-mode)))
#+end_src

**** [[https://github.com/zkry/yaml-pro][yaml-pro]]

Use treesitter to make yaml mode go faster.

#+begin_src emacs-lisp :name yaml-pro
  (use-package yaml-pro
    :hook (yaml-mode . yaml-ts-mode-hook)
    :config
    ;; the original bindings will work as well, these are shorter if you prefer them.
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-n" #'yaml-pro-ts-next-subtree)
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-p" #'yaml-pro-ts-prev-subtree)
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-u" #'yaml-pro-ts-up-level)
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-d" #'yaml-pro-ts-down-level)
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-k" #'yaml-pro-ts-kill-subtree)
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-<backspace>" #'yaml-pro-ts-kill-subtree)
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-a" #'yaml-pro-ts-first-sibling)
    ;;(keymap-set yaml-pro-ts-mode-map "C-M-e" #'yaml-pro-ts-last-sibling)

    (deftpunk-local-leader-def
      :keymaps 'yaml-pro-ts-mode-map
      "n" '(yaml-pro-ts-next-subtree :which-key "Next subtree")
      "p" '(yaml-pro-ts-prev-subtree :which-key "Previous subtree")
      "u" '(yaml-pro-ts-up-level :which-key "Up subtree")
      "d" '(yaml-pro-ts-down-level :which-key "Down subtree")
      "k" '(yaml-pro-ts-kill-subtree :which-key "Kill subtree")
      "<backspace>" '(yaml-pro-ts-kill-subtree :which-key "Kill subtree")
      "a" '(yaml-pro-ts-first-sibling :which-key "First sibling")
      "e" '(yaml-pro-ts-last-sibling :which-key "Last sibling")
      )

    (defvar-keymap my/yaml-pro/tree-repeat-map
      :repeat t
      "n" #'yaml-pro-ts-next-subtree
      "p" #'yaml-pro-ts-prev-subtree
      "u" #'yaml-pro-ts-up-level
      "d" #'yaml-pro-ts-down-level
      "m" #'yaml-pro-ts-mark-subtree
      "k" #'yaml-pro-ts-kill-subtree
      "a" #'yaml-pro-ts-first-sibling
      "e" #'yaml-pro-ts-last-sibling
      "SPC" #'my/yaml-pro/set-mark)

    (defun my/yaml-pro/set-mark ()
      (interactive)
      (my/region/set-mark 'my/yaml-pro/set-mark))

    (defun my/region/set-mark (command-name)
      (if (eq last-command command-name)
          (if (region-active-p)
              (progn
                (deactivate-mark)
                (message "Mark deactivated"))
            (activate-mark)
            (message "Mark activated"))
        (set-mark-command nil))))
#+end_src

** Terminals & Shells

Terminals, shells, consoles ... oh my.

*** [[https://github.com/akermu/emacs-libvterm][vterm]]

A fully-fledged terminal emulator inside GNU Emacs based on libvterm - which will need to be compiled.

Don't forget to do the following [[https://github.com/akermu/emacs-libvterm?tab=readme-ov-file#shell-side-configuration][shell-side-configuration]] in =.zshrc=

TODO: toggle-vterm or multi-vterm?

#+begin_src emacs-lisp :name vterm
  (use-package vterm
    :ensure t
    :hook
    ;; Change the face so its more obvious we are in an emulator.
    (vterm-mode . (lambda ()
                    (set (make-local-variable 'buffer-face-mode-face) 'fixed-pitch)
                    (buffer-face-mode t)))
    :custom
    (vterm-always-compile-module t)
    (vterm-max-scrollback 100000)               ; the max without changing vterm-module.h and re-compiling
    (vterm-copy-mode-remove-fake-newlines t))
#+end_src

**** [[https://github.com/suonlight/multi-vterm][multi-vterm]]

Managing multiple vterm buffers in Emacs.

TODO: Use consult to choose multi-vterms.  See =multi-vterm-project-root= function for code to determine if in project or not.

#+begin_src emacs-lisp :multi-vterm
  (use-package multi-vterm
    :ensure t
    :general
    (:prefix "C-c t"
             "t" #'multi-vterm
             "d" #'multi-vterm-dedicated-toggle
             "n" #'multi-vterm-next
             "p" #'multi-vterm-previous))
#+end_src

** Keybindings and related functionality
*** Matching parens ala %

#+begin_src emacs-lisp :name matching-parens
  ;; Trying out matching parens
  ;; https://www.gnu.org/software/emacs/manual/html_node/efaq/Matching-parentheses.html
  (defun match-paren (arg)
    "Go to the matching paren if on a paren; otherwise insert %."
    (interactive "p")
    (cond ((looking-at "\\s(") (forward-list 1) (backward-char 1))
          ((looking-at "\\s)") (forward-char 1) (backward-list 1))
          (t (self-insert-command (or arg 1)))))

  (global-set-key "%" 'match-paren)
#+end_src

*** Making escape do more quiting.

I might as well take advantage of my Neovim habit.

#+begin_src emacs-lisp :name escape
  ;; From https://protesilaos.com/codelog/2024-11-28-basic-emacs-configuration/
  (defun prot/keyboard-quit-dwim ()
    "Do-What-I-Mean behaviour for a general `keyboard-quit'.

  The generic `keyboard-quit' does not do the expected thing when
  the minibuffer is open.  Whereas we want it to close the
  minibuffer, even without explicitly focusing it.

  The DWIM behaviour of this command is as follows:

  - When the region is active, disable it.
  - When a minibuffer is open, but not focused, close the minibuffer.
  - When the Completions buffer is selected, close it.
  - In every other case use the regular `keyboard-quit'."
    (interactive)
    (cond
     ((region-active-p)
      (keyboard-quit))
     ((derived-mode-p 'completion-list-mode)
      (delete-completion-window))
     ((> (minibuffer-depth) 0)
      (abort-recursive-edit))
     (t
      (keyboard-quit))))

  (define-key global-map (kbd "C-g") #'prot/keyboard-quit-dwim)

  ;; Some final remapping of Escape to "Quit"

  (global-set-key (kbd "<escape>") 'keyboard-quit)

  ;; When C-g gets rebound.
  (define-key key-translation-map (kbd "ESC") (kbd "C-g"))

  (define-key minibuffer-local-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-ns-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-completion-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-must-match-map [escape] 'minibuffer-keyboard-quit)
  (define-key minibuffer-local-isearch-map [escape] 'minibuffer-keyboard-quit)
#+end_src

*** Rectangle hydra

A Hydra for dealing w/ rectangle selection.
https://oremacs.com/2015/02/25/rectangle-hydra/

#+begin_src emacs-lisp :name rectangle-hydra
  (defun ora-ex-point-mark ()
    (interactive)
    (if rectangle-mark-mode
        (exchange-point-and-mark)
      (let ((mk (mark)))
        (rectangle-mark-mode 1)
        (goto-char mk))))

  (defhydra hydra-rectangle (:body-pre (rectangle-mark-mode 1)
                             :color pink
                             :post (deactivate-mark))
    "
    ^_k_^     _d_elete    _s_tring     |\\     ‗,,,--,,‗
  _h_   _l_   _o_k        _y_ank       /,`.-'`'   .‗  \-;;,‗
    ^_j_^     _n_ew-copy  _r_eset     |,4-  ) )‗   .;.(  `'-'
  ^^^^        _e_xchange  _u_ndo     '---''(‗/.‗)-'(‗\‗)
  ^^^^        ^ ^         _p_aste
  "
    ("h" backward-char nil)
    ("l" forward-char nil)
    ("k" previous-line nil)
    ("j" next-line nil)
    ("e" ora-ex-point-mark nil)
    ("n" copy-rectangle-as-kill nil)
    ("d" delete-rectangle nil)
    ("r" (if (region-active-p)
             (deactivate-mark)
           (rectangle-mark-mode 1)) nil)
    ("y" yank-rectangle nil)
    ("u" undo nil)
    ("s" string-rectangle nil)
    ("p" kill-rectangle nil)
    ("o" nil nil))

  (global-set-key (kbd "C-x SPC") 'hydra-rectangle/body)
#+end_src

*** deftpunk-g-def bindings

Just like the Neovim "g<letter>" bindings.

#+begin_src emacs-lisp :name deftpunk-g-def
    ;; NOTE: The org-open-at-point will open a "Babel Results" window when this function is called
    ;;       inside a src block
    (defun deftpunk/url-at-point ()
      "Make opening the url at point a little more flexible."
      (interactive)
      (if (string-equal major-mode "org-mode")
          (unless (ignore-errors (or (org-open-at-point) t))
            (ace-link))
        (unless (ignore-errors (or (browse-url-at-point) t))
          (ace-link))))

    (general-create-definer deftpunk-g-def
      :prefix "s-g")

  (deftpunk-g-def
      "g"   '(goto-line :which-keys "Go to line number")
      "s-g" '(goto-line :which-keys "Go to line number")
      "o"   '(ace-link :which-keys "Highlight links in document")
      "x"   '(deftpunk/url-at-point :which-keys "Visit link at point")
      )
#+end_src

*** Window management/navigation bindings

#+begin_src emacs-lisp :name windows-bindings
  (global-set-key (kbd "C--") 'ace-window)

  ;; Move around
  (global-set-key (kbd "s-h") 'windmove-left)
  (global-set-key (kbd "s-j") 'windmove-down)
  (global-set-key (kbd "s-k") 'windmove-up)
  (global-set-key (kbd "s-l") 'windmove-right)
#+end_src

*** Some aliases

#+begin_src emacs-lisp :name defaliases
  (defalias 'ff 'find-file)
#+end_src

*** Deftpunk keybindings

#+begin_src emacs-lisp :name deftpunk-keybindings
    ;; https://www.reddit.com/r/emacs/comments/r7l3ar/comment/hn3kuwh/?utm_source=share&utm_medium=web2x&context=3
    (defun my/scroll-down-half-page ()
      "scroll down half a page while keeping the cursor centered"
      (interactive)
      (let ((ln (line-number-at-pos (point)))
            (lmax (line-number-at-pos (point-max))))
        (cond ((= ln 1) (move-to-window-line nil))
              ((= ln lmax) (recenter (window-end)))
              (t (progn
                   (move-to-window-line -1)
                   (recenter))))))

    (defun my/scroll-up-half-page ()
      "scroll up half a page while keeping the cursor centered"
      (interactive)
      (let ((ln (line-number-at-pos (point)))
            (lmax (line-number-at-pos (point-max))))
        (cond ((= ln 1) nil)
              ((= ln lmax) (move-to-window-line nil))
              (t (progn
                   (move-to-window-line 0)
                   (recenter))))))


  (global-set-key (kbd "s-u") 'my/scroll-up-half-page)
  (global-set-key (kbd "s-d") 'my/scroll-down-half-page)

  (global-set-key (kbd "s-s") 'consult-line)

    ;; Using C-j for jumping around.
    (global-unset-key (kbd "C-j"))
    (global-set-key (kbd "C-j") 'avy-goto-char-timer)
    (global-set-key (kbd "s-f") 'avy-goto-char-in-line)

    ;; Figure out hippie-expand
    ;; From https://stackoverflow.com/a/43665319
    (defun my-expand-lines ()
      "My old friend C-x C-l in Emacs"
      (interactive)
      (let ((hippie-expand-try-functions-list
         '(try-expand-line)))
        (call-interactively 'hippie-expand)))

    (global-unset-key (kbd "C-x C-l")) ; I can downcase the region another way.
    (global-set-key (kbd "C-x C-l") 'my-expand-lines)

  ;; Repeating
  (global-unset-key (kbd "C-z"))
  (global-set-key (kbd "C-.") 'repeat) ; repeats single command w/out minibuffer input, userful for deletions, instertions, movement keys
  (global-set-key (kbd "C-z") 'repeat-complex-command) ; repeat complex commands that involve minibuffer input
#+end_src

*** Leader bindings

#+begin_src emacs-lisp :name leader-bindings
  (defhydra deftpunk-leader ()
    ("g g" magit                "Magit"               :column "Source Control")
    ("g d" magit-dispatch       "Magit Dispatch"      :column "Source Control")
    ("g f" magit-file-dispatch  "Magit File Dispatch" :column "Source Control")
    ("g l" magit-file-dispatch  "Git Link"            :column "Source Control")
    ("g s" magit-status         "Git Status"          :column "Source Control")
    ("g t" git-timemachine-mode "Git Timemachine"     :column "Source Control")
    ("i" consult-buffer         "Buffers"              :column "Buffers/Files/Projects")
    ("p a" project-async-shell-command "Run shell command"   :column "Buffers/Files/Projects")
    ("p p" project-switch-project "Switch Projects"   :column "Buffers/Files/Projects")
    ("t n" treemacs                      "Treemacs"            :column "Utilities")
    ("t t" multi-vterm-dedicated-toggle  "Toggled Vterm"            :column "Utilities")
    )

  (global-set-key (kbd "s-<SPC>") 'deftpunk-leader/body)
#+end_src

*** [[https://www.emacswiki.org/emacs/key-chord.el][key-chord]]

Map pairs of simultaneously pressed keys to commands.

Keychord does have some drawbacks:
1. Doesn't get recorded when recording macros.
2. Can't use function keys in keychords
3. Doesn't work well with internationalization packages.

I use something similar in Neovim to bring up ":"

#+begin_src emacs-lisp :name jk-binding
  (use-package key-chord
    :commands (key-chord-define-global)
    :init
    (key-chord-mode 1)
    :config
    (key-chord-define-global "jk" 'execute-extended-command)
    (key-chord-define-global "hh" 'split-window-below)
    (key-chord-define-global "vv" 'split-window-right))
#+end_src

** Server

Start the emacs server as a last thing to do.

#+begin_src emacs-lisp :name emacs-server
  (server-start)
#+end_src

** Investigations
*** SOPS encrypt/decrypt
https://github.com/djgoku/sops
*** dirvish
https://github.com/alexluigit/dirvish
